<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Feuilles Porte ECOS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .generator-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 8px;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #preview {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            min-height: 200px;
        }

        .file-input-wrapper {
            margin: 20px 0;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            background-color: #2196F3;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }

        .file-input-label:hover {
            background-color: #1976D2;
        }

        .error {
            color: #d32f2f;
            margin-top: 10px;
        }

        /* Styles pour la feuille porte g√©n√©r√©e */
        .feuille-porte {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 40px;
            background-color: white;
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }

        .feuille-porte .titre-station {
            text-align: right;
            color: #bfbfbf;
            font-size: 14px;
            margin-bottom: 40px;
        }

        .feuille-porte h2 {
            color: #333;
            font-size: 20px;
            margin: 60px 0 100px 0;
            font-weight: bold;
        }

        .feuille-porte .contexte {
            margin: 100px 0 100px 0;
        }
        
        .feuille-porte .contexte-label {
            font-weight: bold;
        }

        .feuille-porte .description {
            margin-bottom: 20px;
            text-align: justify;
            line-height: 1.3;
        }

        .feuille-porte .signes-vitaux {
            margin-top: 20px;
            line-height: 1.3;
        }

        .feuille-porte .signes-vitaux li {
            list-style-type: disc;
            margin: 4px 0;
            margin-left: 20px;
        }

        .feuille-porte .taches {
            position: absolute;
            top: 560px;
            left: 40px;
            right: 40px;
            margin: 0;
            line-height: 1.3;
        }
        
        @media screen {
            .feuille-porte {
                position: relative;
                min-height: 800px;
            }
        }

        .feuille-porte .taches li {
            margin: 4px 0;
        }
        
        .feuille-porte .remarque {
            margin-top: 40px;
            font-style: italic;
            color: #555;
            line-height: 1.3;
        }

        @media print {
            body {
                background-color: white;
                margin: 0;
            }

            .generator-container {
                display: none !important;
            }

            #preview {
                display: block !important;
                padding: 0;
                background-color: white;
                margin: 0;
            }

            .feuille-porte {
                display: block !important;
                padding: 30px 40px;
                page-break-inside: avoid;
                position: relative;
                min-height: 800px;
            }
            
            .feuille-porte .taches {
                position: absolute;
                top: 560px;
                left: 40px;
                right: 40px;
                margin: 0;
            }

            .feuille-porte .taches li {
                margin: 4px 0;
            }
        }
    </style>
</head>

<body>
    <div class="generator-container">
        <h1>üìÑ G√©n√©rateur de Feuilles Porte ECOS</h1>
        
        <div class="input-section">
            <h2>1Ô∏è‚É£ Charger un fichier JSON</h2>
            <div class="file-input-wrapper">
                <label for="fileInput" class="file-input-label">
                    üìÅ S√©lectionner un fichier JSON
                </label>
                <input type="file" id="fileInput" accept=".json">
                <span id="fileName" style="margin-left: 10px;"></span>
            </div>
            
            <h2>2Ô∏è‚É£ Ou saisir les donn√©es JSON directement</h2>
            <textarea id="jsonInput" placeholder="Collez ici les donn√©es JSON de la feuille porte..."></textarea>
            
            <button onclick="generateFeuillePorte()">üîÑ G√©n√©rer la feuille porte</button>
            <button onclick="downloadFeuillePorte()" id="downloadBtn" disabled>üíæ T√©l√©charger la feuille porte</button>
            <button onclick="printFeuillePorte()" id="printBtn" disabled>üñ®Ô∏è Imprimer / Sauvegarder en PDF</button>
            
            <div id="error" class="error"></div>
        </div>

        <div id="preview"></div>
    </div>

    <script>
        let currentFeuillePorteData = null;

        // Fonction pour formater le titre (garde les chiffres arabes)
        function formatTitre(titre) {
            // Retourne le titre sans modification
            return titre;
        }

        // Exemple de structure JSON
        const exempleJSON = {
            "titre": "C√©phal√©es 1",
            "contexte": "Cabinet de m√©decine g√©n√©rale",
            "description": "Homme de 70 ans consultant pour contr√¥le de tension art√©rielle, mentionne des c√©phal√©es.",
            "signesVitaux": {
                "tensionArterielle": "152/94 mmHg",
                "frequenceCardiaque": "70 bpm",
                "frequenceRespiratoire": "12/min",
                "temperature": "36.6¬∞C"
            },
            "taches": [
                "Effectuer une anamn√®se cibl√©e",
                "R√©aliser un examen clinique orient√©",
                "√âvoquer un diagnostic principal et des diagnostics diff√©rentiels",
                "Proposer une prise en charge th√©rapeutique appropri√©e"
            ],
            "remarque": "D√©crivez √† haute voix pour l'examinateur-trice tout ce que vous faites √† l'examen physique."
        };

        // Afficher l'exemple au chargement
        document.getElementById('jsonInput').value = JSON.stringify(exempleJSON, null, 2);

        // Gestion du chargement de fichier
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        document.getElementById('jsonInput').value = JSON.stringify(jsonData, null, 2);
                        generateFeuillePorte();
                    } catch (error) {
                        showError("Erreur lors de la lecture du fichier: " + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        function showError(message) {
            document.getElementById('error').textContent = message;
            setTimeout(() => {
                document.getElementById('error').textContent = '';
            }, 5000);
        }

        function generateFeuillePorte() {
            const jsonInput = document.getElementById('jsonInput').value;
            
            try {
                currentFeuillePorteData = JSON.parse(jsonInput);
                
                // Validation des donn√©es
                if (!currentFeuillePorteData.titre || !currentFeuillePorteData.taches) {
                    throw new Error("Les champs 'titre' et 'taches' sont obligatoires");
                }
                
                // G√©n√©ration du HTML
                const html = generateHTML(currentFeuillePorteData);
                document.getElementById('preview').innerHTML = html;
                
                // Activer les boutons
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('printBtn').disabled = false;
                
                showError(''); // Effacer les erreurs
                
            } catch (error) {
                showError("Erreur: " + error.message);
            }
        }

        function generateHTML(data) {
            let html = `
            <div class="feuille-porte">
                <div class="titre-station">${formatTitre(data.titre)}</div>
                
                <h2>T√¢che des candidats</h2>
                
                ${data.contexte ? `<div class="contexte"><span class="contexte-label">Contexte :</span> ${data.contexte}</div>` : ''}
                
                <div class="description">${data.description}</div>
            `;
            
            // Signes vitaux (optionnels)
            if (data.signesVitaux) {
                html += `
                <ul class="signes-vitaux">
                `;
                
                // V√©rifier si c'est une note sp√©ciale
                if (data.signesVitaux.note) {
                    // Mettre la premi√®re lettre en minuscule
                    const noteMinuscule = data.signesVitaux.note.charAt(0).toLowerCase() + data.signesVitaux.note.slice(1);
                    html += `<li>Signes vitaux ${noteMinuscule}</li>`;
                } else {
                    // Signes vitaux individuels
                    if (data.signesVitaux.tensionArterielle) {
                        html += `<li>Tension art√©rielle : ${data.signesVitaux.tensionArterielle}</li>`;
                    }
                    if (data.signesVitaux.frequenceCardiaque) {
                        html += `<li>Fr√©quence cardiaque : ${data.signesVitaux.frequenceCardiaque}</li>`;
                    }
                    if (data.signesVitaux.frequenceRespiratoire) {
                        html += `<li>Fr√©quence respiratoire : ${data.signesVitaux.frequenceRespiratoire}</li>`;
                    }
                    if (data.signesVitaux.temperature) {
                        html += `<li>Temp√©rature : ${data.signesVitaux.temperature}</li>`;
                    }
                    if (data.signesVitaux.saturation) {
                        html += `<li>Saturation : ${data.signesVitaux.saturation}</li>`;
                    }
                    if (data.signesVitaux.sao2) {
                        html += `<li>SaO2 : ${data.signesVitaux.sao2}</li>`;
                    }
                    if (data.signesVitaux.imc) {
                        html += `<li>IMC : ${data.signesVitaux.imc}</li>`;
                    }
                }
                
                html += `</ul>`;
            }
            
            // T√¢ches
            html += `
                <div class="taches">
                    <p><strong>Vous disposez de 13 minutes pour :</strong></p>
                    <ol>
            `;
            
            data.taches.forEach(tache => {
                html += `                        <li>${tache}</li>`;
            });
            
            html += `
                    </ol>
                    ${data.remarque ? `<p style="margin-top: 40px; font-style: italic; color: #555;">${data.remarque}</p>` : ''}
                </div>
            </div>
            `;
            
            return html;
        }

        function downloadFeuillePorte() {
            if (!currentFeuillePorteData) return;
            
            // Utiliser le titre original avec " - Feuille porte" √† la fin
            const filename = `${currentFeuillePorteData.titre} - Feuille porte.html`;
            const htmlContent = generateCompleteHTML(currentFeuillePorteData);
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateCompleteHTML(data) {
            // Construction du HTML en parties pour √©viter les conflits de template literals
            let htmlPart1 = '<!DOCTYPE html>\n<html lang="fr">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>' + data.titre + ' - Feuille porte</title>\n    <style>\n        body {\n            font-family: Arial, sans-serif;\n            margin: 0;\n            padding: 0;\n            background-color: white;\n        }\n        \n        .feuille-porte {\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 30px 40px;\n            background-color: white;\n            font-family: Arial, sans-serif;\n            line-height: 1.6;\n            position: relative;\n            min-height: 800px;\n        }\n        \n        .titre-station {\n            text-align: right;\n            color: #bfbfbf;\n            font-size: 14px;\n            margin-bottom: 40px;\n        }\n        \n        h2 {\n            color: #333;\n            font-size: 20px;\n            margin: 60px 0 100px 0;\n            font-weight: bold;\n        }\n        \n        .contexte {\n            margin: 100px 0 100px 0;\n        }\n        \n        .contexte-label {\n            font-weight: bold;\n        }\n        \n        .description {\n            margin-bottom: 20px;\n            text-align: justify;\n            line-height: 1.3;\n        }\n        \n        .signes-vitaux {\n            margin-top: 20px;\n            line-height: 1.3;\n        }\n        \n        .signes-vitaux li {\n            list-style-type: disc;\n            margin: 4px 0;\n        }\n        \n        .taches {\n            position: absolute;\n            top: 560px;\n            left: 40px;\n            right: 40px;\n            margin: 0;\n            line-height: 1.3;\n        }\n        \n        .taches li {\n            margin: 4px 0;\n        }\n        \n        .remarque {\n            margin-top: 40px;\n            font-style: italic;\n            color: #555;\n            line-height: 1.3;\n        }\n        \n        @media print {\n            body {\n                margin: 0;\n            }\n            \n            .feuille-porte {\n                padding: 30px 40px;\n                page-break-inside: avoid;\n            }\n            \n            .taches {\n                position: absolute;\n                top: 560px;\n            left: 40px;\n            right: 40px;\n            margin: 0;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class="feuille-porte">\n        <div class="titre-station">' + formatTitre(data.titre) + '</div>\n        \n        <h2>T√¢che des candidats</h2>\n';
            
            if (data.contexte) {
                htmlPart1 += '        <div class="contexte"><span class="contexte-label">Contexte :</span> ' + data.contexte + '</div>\n';
            }
            
            htmlPart1 += '        \n        <div class="description">' + data.description + '</div>\n';
            
            if (data.signesVitaux) {
                htmlPart1 += '        \n        <ul class="signes-vitaux">\n';
                
                // V√©rifier si c'est une note sp√©ciale
                if (data.signesVitaux.note) {
                    // Mettre la premi√®re lettre en minuscule
                    const noteMinuscule = data.signesVitaux.note.charAt(0).toLowerCase() + data.signesVitaux.note.slice(1);
                    htmlPart1 += '            <li>Signes vitaux ' + noteMinuscule + '</li>\n';
                } else {
                    // Signes vitaux individuels
                    if (data.signesVitaux.tensionArterielle) {
                        htmlPart1 += '            <li>Tension art√©rielle : ' + data.signesVitaux.tensionArterielle + '</li>\n';
                    }
                    if (data.signesVitaux.frequenceCardiaque) {
                        htmlPart1 += '            <li>Fr√©quence cardiaque : ' + data.signesVitaux.frequenceCardiaque + '</li>\n';
                    }
                    if (data.signesVitaux.frequenceRespiratoire) {
                        htmlPart1 += '            <li>Fr√©quence respiratoire : ' + data.signesVitaux.frequenceRespiratoire + '</li>\n';
                    }
                    if (data.signesVitaux.temperature) {
                        htmlPart1 += '            <li>Temp√©rature : ' + data.signesVitaux.temperature + '</li>\n';
                    }
                    if (data.signesVitaux.saturation) {
                        htmlPart1 += '            <li>Saturation : ' + data.signesVitaux.saturation + '</li>\n';
                    }
                    if (data.signesVitaux.sao2) {
                        htmlPart1 += '            <li>SaO2 : ' + data.signesVitaux.sao2 + '</li>\n';
                    }
                    if (data.signesVitaux.imc) {
                        htmlPart1 += '            <li>IMC : ' + data.signesVitaux.imc + '</li>\n';
                    }
                }
                
                htmlPart1 += '        </ul>\n';
            }
            
            htmlPart1 += '        \n        <div class="taches">\n            <p><strong>Vous disposez de 13 minutes pour :</strong></p>\n            <ol>\n';
            
            data.taches.forEach(tache => {
                htmlPart1 += '                <li>' + tache + '</li>\n';
            });
            
            htmlPart1 += '            </ol>\n';
            
            if (data.remarque) {
                htmlPart1 += '            <p style="margin-top: 40px; font-style: italic; color: #555;">' + data.remarque + '</p>\n';
            }
            
            htmlPart1 += '        </div>\n    </div>\n</body>\n</html>';
            
            return htmlPart1;
        }

        function printFeuillePorte() {
            if (!currentFeuillePorteData) {
                alert('Veuillez d\'abord g√©n√©rer une feuille porte');
                return;
            }
            
            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank');
            const htmlContent = generateCompleteHTML(currentFeuillePorteData);
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // D√©finir le nom du fichier sugg√©r√© pour l'impression/PDF
            const titre = currentFeuillePorteData.titre || 'Feuille Porte';
            printWindow.document.title = titre + ' - Feuille porte';
            
            // Attendre que le contenu soit charg√© puis imprimer
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }
    </script>
</body>

</html>
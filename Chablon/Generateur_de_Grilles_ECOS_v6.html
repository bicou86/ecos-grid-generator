<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de grilles ECOS v6 - Structure Standardis√©e</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .generator-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #e3f2fd;
            border-radius: 8px;
        }

        textarea {
            width: 100%;
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background-color: #45a049;
        }

        .download-btn {
            background-color: #2196F3;
        }

        .download-btn:hover {
            background-color: #0b7dda;
        }

        .print-btn {
            background-color: #FF9800;
        }

        .print-btn:hover {
            background-color: #F57C00;
        }

        .error {
            color: red;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            display: none;
        }

        .success {
            color: green;
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
            display: none;
        }

        .preview-section {
            margin-top: 30px;
            display: none;
        }

        iframe {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .instructions {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .file-input {
            margin: 10px 0;
        }

        .example-link {
            color: #2196F3;
            text-decoration: none;
        }

        .example-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="generator-container">
        <h1>G√©n√©rateur de grilles d'√©valuation ECOS <span style="background-color: #ff6b6b; color: white; padding: 5px 10px; border-radius: 4px; font-size: 14px; margin-left: 10px;">v6.0</span></h1>

        <div class="instructions" style="background-color: #e3f2fd; border-color: #2196f3; color: #0d47a1;">
            <h3>üöÄ Nouveaut√©s de la version 6</h3>
            <ul>
                <li>‚ú® Structure d'annexes compl√®tement standardis√©e (3 sections principales)</li>
                <li>üè∑Ô∏è Labels fran√ßais automatiques pour toutes les sections</li>
                <li>üîÑ G√©n√©ration dynamique bas√©e sur la structure JSON</li>
                <li>üìã Support complet de tous les types de donn√©es (objets, arrays, strings)</li>
                <li>üéØ Regroupement intelligent des sections similaires</li>
                <li>üíæ Compatible avec la nouvelle structure v3 des annexes</li>
                <li>üé® Coloration automatique des r√©ponses patient entre crochets</li>
                <li>‚ö° Performance optimis√©e pour les grandes structures</li>
            </ul>
            <p><strong>Structure standardis√©e :</strong> scenarioPatienteStandardisee, informationsExpert, theoriePratique</p>
        </div>

        <div class="instructions">
            <h3>üìã Instructions d'utilisation</h3>
            <ol>
                <li>Collez vos donn√©es JSON dans la zone de texte ci-dessous ou chargez un fichier JSON</li>
                <li>Cliquez sur "G√©n√©rer la grille ECOS" pour cr√©er le fichier HTML</li>
                <li>Pr√©visualisez le r√©sultat</li>
                <li>T√©l√©chargez le fichier HTML g√©n√©r√©</li>
            </ol>
            <p><strong>Format attendu :</strong> Les donn√©es doivent contenir les sections anamnese, examen et
                management. La section communication est standardis√©e et sera ajout√©e automatiquement.</p>
            <p><strong>Note :</strong> La section Communication est identique pour tous les cas ECOS (4 crit√®res,
                notation A-E, 25% de la note finale).</p>
            <p><strong>Images :</strong> Les annexes peuvent contenir des images. Utilisez le chemin "grilles_generees/images/nom-image.jpg" dans le JSON. Les images seront automatiquement converties en chemins relatifs dans le HTML g√©n√©r√©.</p>
        </div>

        <div class="input-section">
            <h2>Donn√©es JSON du cas ECOS</h2>

            <div class="file-input">
                <label for="fileInput">Charger un fichier JSON : </label>
                <input type="file" id="fileInput" accept=".json">
            </div>

            <textarea id="jsonInput" placeholder="Collez vos donn√©es JSON ici..."></textarea>

            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>

            <button id="generateBtn">G√©n√©rer la grille ECOS</button>
            <button class="download-btn" id="downloadBtn" style="display: none;">T√©l√©charger le fichier HTML</button>
            <button class="print-btn" id="printBtn" style="display: none;">üñ®Ô∏è Imprimer / Sauvegarder en PDF</button>
        </div>

        <div class="preview-section" id="previewSection">
            <h2>Aper√ßu de la grille g√©n√©r√©e</h2>
            <iframe id="previewFrame"></iframe>
        </div>
    </div>

    <script>

        // Variables globales
        let generatedHTML = '';
        let currentData = null;

        // Fonctions utilitaires
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Fonction pour g√©n√©rer les crit√®res
        function generateCriteriaRows(criteria, prefix) {
            return criteria.map((criterion, index) => {
                const num = index + 1;
                const id = criterion.id || (prefix + num);
                
                let detailsHtml = '';
                let patientCommentHtml = '';
                
                // Gestion des d√©tails du crit√®re
                let hasDetailsCheckboxes = false;
                if (criterion.details && criterion.details.length > 0) {
                    const validDetails = criterion.details.filter(d => 
                        d && d.trim() !== '' && !d.includes('[Sous-crit√®re') && !d.includes('[D√©tail')
                    );
                    if (validDetails.length > 0) {
                        // Si plus d'un d√©tail, on cr√©e des checkboxes pour chaque d√©tail
                        if (validDetails.length > 1) {
                            hasDetailsCheckboxes = true;
                            detailsHtml = '<div class="details-with-checkboxes">';
                            validDetails.forEach((detail, detailIndex) => {
                                const detailId = id + '-detail-' + detailIndex;
                                detailsHtml += '<div class="detail-row">';
                                // Traiter les crochets dans les d√©tails comme pour patientComment
                                let detailWithBrackets = detail;
                                detailWithBrackets = detailWithBrackets.replace(/\[([^\]]+)\]/g, '<span class="patient-response">[$1]</span>');
                                detailsHtml += '    <div class="detail-text criteria-detail">' + detailWithBrackets + '</div>';
                                detailsHtml += '    <div class="detail-checkboxes">';
                                detailsHtml += '        <label class="detail-checkbox"><input type="checkbox" id="' + detailId + '" value="1" onchange="updateDetailScore(\'' + id + '\', \'' + prefix + '\')" /></label>';
                                detailsHtml += '    </div>';
                                detailsHtml += '</div>';
                            });
                            detailsHtml += '</div>';
                        } else {
                            // Un seul d√©tail, affichage normal
                            detailsHtml = validDetails.map(d => {
                                // Traiter les crochets dans les d√©tails
                                let detailWithBrackets = d.replace(/\[([^\]]+)\]/g, '<span class="patient-response">[$1]</span>');
                                return '<div class="sub-criteria">' + detailWithBrackets + '</div>';
                            }).join('');
                        }
                    }
                }
                
                if (criterion.patientComment) {
                    patientCommentHtml = ' <span class="patient-response">[' + criterion.patientComment + ']</span>';
                }
                
                // Gestion des exemples de phrases
                let exemplesPhraseHtml = '';
                if (criterion.exemplesPhrases && criterion.exemplesPhrases.length > 0) {
                    exemplesPhraseHtml = '<div class="exemples-phrases">';
                    criterion.exemplesPhrases.forEach(phrase => {
                        exemplesPhraseHtml += '<div class="exemple-phrase">"' + phrase + '"</div>';
                    });
                    exemplesPhraseHtml += '</div>';
                }

                let scoringRuleHtml = '';
                if (criterion.scoringRule) {
                    scoringRuleHtml = '<div class="scoring-rule">' + criterion.scoringRule + '</div>';
                }

                let therapySectionHtml = '';
                if (criterion.therapySection) {
                    criterion.therapySection.categories.forEach(category => {
                        therapySectionHtml += '        <div class="therapy-section">\n';
                        // Utiliser 'name' ou 'title' pour le titre de la cat√©gorie
                        const categoryTitle = category.title || category.name || '';
                        if (categoryTitle) {
                            therapySectionHtml += '            <div class="therapy-title">' + categoryTitle + '</div>\n';
                        }
                        
                        // Si la cat√©gorie a un contenu direct
                        if (category.content) {
                            therapySectionHtml += '            <div>' + category.content.replace(/‚Ä¢/g, '<span style="margin-left: 10px;">‚Ä¢</span>').replace(/\n/g, '<br />\n            ') + '</div>\n';
                        }
                        
                        // Si la cat√©gorie a des items
                        if (category.items && Array.isArray(category.items)) {
                            therapySectionHtml += '            <div class="therapy-items">\n';
                            category.items.forEach(item => {
                                therapySectionHtml += '                <div class="therapy-item" style="margin: 10px 0;">\n';
                                if (item.treatment) {
                                    therapySectionHtml += '                    <div><strong>Traitement :</strong> ' + item.treatment + '</div>\n';
                                }
                                if (item.details) {
                                    therapySectionHtml += '                    <div style="margin-left: 20px; color: #666;"><em>D√©tails :</em> ' + item.details + '</div>\n';
                                }
                                if (item.duration) {
                                    therapySectionHtml += '                    <div style="margin-left: 20px; color: #666;"><em>Dur√©e :</em> ' + item.duration + '</div>\n';
                                }
                                therapySectionHtml += '                </div>\n';
                            });
                            therapySectionHtml += '            </div>\n';
                        }
                        
                        therapySectionHtml += '        </div>\n';
                    });
                }

                let redflagsSectionHtml = '';
                if (criterion.redflagsSection) {
                    // Si redflagsSection est un tableau direct (format simple)
                    if (Array.isArray(criterion.redflagsSection)) {
                        redflagsSectionHtml += '        <div class="redflags-section">\n';
                        redflagsSectionHtml += '            <div class="redflags-title">‚ö†Ô∏è Red Flags</div>\n';
                        criterion.redflagsSection.forEach((item, index) => {
                            redflagsSectionHtml += '            <div class="redflags-item">\n';
                            redflagsSectionHtml += '                <div class="redflags-text">' + (index + 1) + '. ' + item.text + '</div>\n';
                            if (item.description) {
                                redflagsSectionHtml += '                <div class="redflags-description">' + item.description + '</div>\n';
                            }
                            redflagsSectionHtml += '            </div>\n';
                        });
                        redflagsSectionHtml += '        </div>\n';
                    }
                    // Si redflagsSection est un objet avec title et items
                    else if (typeof criterion.redflagsSection === 'object' && criterion.redflagsSection.items) {
                        redflagsSectionHtml += '        <div class="redflags-section">\n';
                        if (criterion.redflagsSection.title) {
                            redflagsSectionHtml += '            <div class="redflags-title">‚ö†Ô∏è ' + criterion.redflagsSection.title + '</div>\n';
                        } else {
                            redflagsSectionHtml += '            <div class="redflags-title">‚ö†Ô∏è Red Flags</div>\n';
                        }
                        criterion.redflagsSection.items.forEach((item, index) => {
                            redflagsSectionHtml += '            <div class="redflags-item">\n';
                            redflagsSectionHtml += '                <div class="redflags-text">' + (index + 1) + '. ' + item.text + '</div>\n';
                            if (item.description) {
                                redflagsSectionHtml += '                <div class="redflags-description">' + item.description + '</div>\n';
                            }
                            redflagsSectionHtml += '            </div>\n';
                        });
                        redflagsSectionHtml += '        </div>\n';
                    }
                }
                
                let html = '';
                
                // Ajout du subheader s'il existe
                if (criterion.subheader) {
                    html += '<div class="criteria-subheader">' + criterion.subheader + '</div>\n';
                }
                
                if (criterion.description) {
                    html += '<div class="criteria-description" style="font-style: italic; color: #666; margin-bottom: 5px; font-size: 14px;">' + criterion.description + '</div>\n';
                }
                
                html += '<div class="criteria-row" id="criteria-' + id + '">\n';
                html += '    <div>\n';
                html += '        <div class="criteria-text">' + num + '. ' + criterion.text + patientCommentHtml + 
                        ' <button class="comment-button" onclick="toggleComment(\'' + id + '\')" title="Ajouter un commentaire">üìù</button></div>\n';
                html += detailsHtml;
                html += exemplesPhraseHtml;
                html += scoringRuleHtml;
                html += therapySectionHtml; 
                html += redflagsSectionHtml;
                // Ajouter la section de commentaire pour le crit√®re
                html += '        <div class="criterion-comment-section" id="comment-section-' + id + '">\n';
                html += '            <textarea class="comment-textarea" id="comment-' + id + '" placeholder="Commentaire sur ce crit√®re..." oninput="updateCommentButton(\'' + id + '\'); autoResizeTextarea(this);"></textarea>\n';
                html += '        </div>\n';
                html += '    </div>\n';
                
                // Si le crit√®re a des d√©tails avec checkboxes, pas de checkboxes pour le crit√®re principal
                if (hasDetailsCheckboxes) {
                    html += '    <div class="checkbox-group"></div>\n';
                    html += '    <div class="checkbox-group"></div>\n';
                    html += '    <div class="checkbox-group"></div>\n';
                } else if (criterion.binaryOnly) {
                    html += '    <div class="checkbox-group">\n';
                    html += '        <input type="radio" name="' + id + '" value="2" data-criteria="' + criterion.text + '" onchange="updateScore(\'' + prefix + '\', this)" />\n';
                    html += '    </div>\n';
                    html += '    <div class="checkbox-group" style="visibility: hidden;">\n';
                    html += '        <input type="radio" disabled />\n';
                    html += '    </div>\n';
                    html += '    <div class="checkbox-group">\n';
                    html += '        <input type="radio" name="' + id + '" value="0" onchange="updateScore(\'' + prefix + '\', this)" />\n';
                    html += '    </div>\n';
                } else {
                    html += '    <div class="checkbox-group">\n';
                    html += '        <input type="radio" name="' + id + '" value="2" data-criteria="' + criterion.text + '" onchange="updateScore(\'' + prefix + '\', this)" />\n';
                    html += '    </div>\n';
                    html += '    <div class="checkbox-group">\n';
                    html += '        <input type="radio" name="' + id + '" value="1" onchange="updateScore(\'' + prefix + '\', this)" />\n';
                    html += '    </div>\n';
                    html += '    <div class="checkbox-group">\n';
                    html += '        <input type="radio" name="' + id + '" value="0" onchange="updateScore(\'' + prefix + '\', this)" />\n';
                    html += '    </div>\n';
                }
                
                html += '    <div class="points-display" id="points-' + id + '">0</div>\n';
                html += '</div>\n';
                
                if (criterion.ddSection) {
                    html += generateDDSection(criterion.ddSection);
                }
                
                return html;
            }).join('');
        }

        function generateDDSection(ddSection) {
            if (!ddSection) return '';
            
            let html = '<div class="dd-section">\n';
            
            // Ajouter le titre s'il est pr√©sent
            if (ddSection.title) {
                html += '    <div class="dd-title">' + ddSection.title + '</div>\n';
            }
            
            // G√©rer les cat√©gories
            if (ddSection.categories && Array.isArray(ddSection.categories)) {
                ddSection.categories.forEach(category => {
                    html += '    <div class="dd-category">' + category.name + '</div>\n';
                    
                    // Ajouter la sous-cat√©gorie si elle existe
                    if (category.subcategory) {
                        html += '    <div class="dd-subcategory" style="font-style: italic; margin-left: 20px; color: #666;">' + category.subcategory + '</div>\n';
                    }
                    
                    // Ajouter les conditions si elles existent
                    if (category.conditions && Array.isArray(category.conditions) && category.conditions.length > 0) {
                        html += '    <div class="dd-conditions" style="margin-left: 20px; font-size: 0.9em; color: #555;">\n';
                        html += '        <em>Conditions : </em>\n';
                        category.conditions.forEach(condition => {
                            html += '        ‚Ä¢ ' + condition + '<br>\n';
                        });
                        html += '    </div>\n';
                    }
                    
                    if (category.items && Array.isArray(category.items)) {
                        category.items.forEach(item => {
                            // Si l'item est une simple cha√Æne de caract√®res
                            if (typeof item === 'string') {
                                html += '    <div class="dd-item">‚Ä¢ ' + item + '</div>\n';
                            }
                            // Si l'item est un objet
                            else if (typeof item === 'object') {
                                html += '    <div class="dd-item">‚Ä¢ ';
                                
                                // G√©rer les diff√©rentes propri√©t√©s possibles
                                if (item.text) {
                                    html += item.text;
                                } else if (item.name) {
                                    html += item.name;
                                }
                                
                                if (item.test) {
                                    html += ' <span class="dd-test">' + item.test + '</span>';
                                }
                                
                                html += '</div>\n';
                                
                                // Ajouter les causes si pr√©sentes
                                if (item.cause) {
                                    html += '    <div class="dd-causes" style="margin-left: 40px; color: rgb(80, 90, 110); font-size: 0.9em;">';
                                    // Mettre en gras "Arguments POUR" et "Arguments CONTRE" et ajouter une tabulation devant les "‚ñ°"
                                    let formattedCause = item.cause
                                        .replace(/Arguments POUR:/g, '<strong>Arguments POUR:</strong>')
                                        .replace(/Arguments CONTRE:/g, '<strong>Arguments CONTRE:</strong>')
                                        .replace(/\t‚ñ°/g, '&nbsp;&nbsp;&nbsp;&nbsp;‚ñ°')
                                        .replace(/\n/g, '<br>');
                                    html += formattedCause;
                                    html += '</div>\n';
                                }
                                
                                // Ajouter le traitement si pr√©sent
                                if (item.treatment) {
                                    html += '    <div class="dd-treatment" style="margin-left: 40px; color: rgb(52, 105, 46); font-size: 0.9em;">';
                                    html += '<strong>Traitement :</strong> ' + item.treatment;
                                    html += '</div>\n';
                                }
                                
                                // Ajouter les d√©tails si pr√©sents
                                if (item.details) {
                                    html += '    <div class="dd-details" style="margin-left: 40px; color: #666; font-size: 0.9em;">';
                                    html += '<strong>D√©tails :</strong> ' + item.details;
                                    html += '</div>\n';
                                }
                                
                                // Ajouter la dur√©e si pr√©sente
                                if (item.duration) {
                                    html += '    <div class="dd-duration" style="margin-left: 40px; color: #666; font-size: 0.9em;">';
                                    html += '<strong>Dur√©e :</strong> ' + item.duration;
                                    html += '</div>\n';
                                }
                            }
                        });
                    }
                });
            }
            
            html += '</div>\n';
            return html;
        }

        function formatDescription(description) {
            if (!description) return '';
            
            // Remplacer les num√©ros entre parenth√®ses par des retours √† la ligne
            let formatted = description.replace(/\s*\((\d+)\)/g, '<br>($1)');
            
            // Ajouter un retour √† la ligne apr√®s un point suivi d'une majuscule
            // SAUF s'il y a un num√©ro avant le point
            formatted = formatted.replace(/(?<!\d)\.\s+([A-Z])/g, '.<br>$1');
            
            // Ajouter un retour √† la ligne avant un num√©ro suivi d'un point
            formatted = formatted.replace(/\s+(\d+\.)/g, '<br>$1');
            
            // Ajouter un retour √† la ligne apr√®s un point-virgule suivi d'une majuscule
            formatted = formatted.replace(/;\s*([A-Z])/g, ';<br>$1');
            
            // Nettoyer les doubles retours √† la ligne au d√©but
            formatted = formatted.replace(/^(<br>)+/, '');
            
            return formatted;
        }

        function generateAnnexes(annexes) {
    return generateAnnexesV3(annexes);
}

        function generateRedFlagsSection(redflagsSection) {
            if (!redflagsSection) return '';
            
            // Support pour l'ancienne structure (array) et la nouvelle structure (objet avec title et items)
            if (Array.isArray(redflagsSection)) {
                // Ancienne structure
                if (redflagsSection.length === 0) return '';
                
                let html = '\n        <!-- RED FLAGS -->\n';
                html += '        <div class="redflags-main-section">\n';
                html += '            <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è Signes d\'alarme (Red Flags)</h3>\n';
                
                redflagsSection.forEach(category => {
                    html += '            <div class="redflags-category-section">\n';
                    html += '                <h4 style="color: #dc3545; margin: 10px 0;">' + category.category + '</h4>\n';
                    
                    if (category.signs && Array.isArray(category.signs)) {
                        html += '                <ul style="margin-left: 20px;">\n';
                        category.signs.forEach(sign => {
                            html += '                    <li style="margin: 5px 0; color: #666;">' + sign + '</li>\n';
                        });
                        html += '                </ul>\n';
                    }
                    
                    html += '            </div>\n';
                });
                
                html += '        </div>\n';
                return html;
            } else if (typeof redflagsSection === 'object' && redflagsSection.items) {
                // Nouvelle structure
                let html = '\n        <!-- RED FLAGS -->\n';
                html += '        <div class="redflags-main-section">\n';
                html += '            <h3 style="color: #dc3545; margin-bottom: 15px;">‚ö†Ô∏è ' + (redflagsSection.title || 'Signes d\'alarme (Red Flags)') + '</h3>\n';
                
                if (redflagsSection.items && Array.isArray(redflagsSection.items)) {
                    html += '            <ul style="margin-left: 20px;">\n';
                    redflagsSection.items.forEach(item => {
                        html += '                <li style="margin: 5px 0;">\n';
                        if (item.text) {
                            html += '                    <strong style="color: #dc3545;">' + item.text + '</strong>';
                        }
                        if (item.description) {
                            html += '<br><span style="color: #666; margin-left: 20px;">' + item.description + '</span>';
                        }
                        html += '\n                </li>\n';
                    });
                    html += '            </ul>\n';
                }
                
                html += '        </div>\n';
                return html;
            }
            
            return '';
        }

        // Fonction principale de g√©n√©ration
        function generateECOS() {
            try {
                const jsonInput = document.getElementById('jsonInput').value;
                if (!jsonInput.trim()) {
                    showError('Veuillez entrer des donn√©es JSON');
                    return;
                }

                const data = JSON.parse(jsonInput);
                currentData = data; // Stocker les donn√©es pour une utilisation ult√©rieure

                if (!data.title || !data.sections) {
                    showError('Structure JSON invalide. V√©rifiez que votre JSON contient "title" et "sections".');
                    return;
                }

                // D√©tection du format du JSON (ancien ou nouveau)
                const hasTraditionalSections = data.sections.anamnese && data.sections.examen && data.sections.management;
                const isNewFormat = !hasTraditionalSections;
                
                // Mappage des noms de sections pour l'affichage
                const sectionLabels = {
                    'anamnese': 'Anamn√®se',
                    'examen': 'Examen clinique',
                    'management': 'Management',
                    'communication': 'Communication',
                    'presentation': 'Pr√©sentation du cas',
                    'raisonnement': 'Raisonnement clinique',
                    'examens': 'Examens compl√©mentaires'
                };
                
                // Calcul des scores maximums
                let maxScores = {};
                let maxTotal = 0;
                
                // Fonction pour calculer le score max d'une section
                function calculateSectionMaxScore(criteria) {
                    let maxScore = 0;
                    criteria.forEach(criterion => {
                        if (criterion.details && criterion.details.length > 1) {
                            // Si plus d'un d√©tail, chaque d√©tail vaut 1 point
                            const validDetails = criterion.details.filter(d => 
                                d && d.trim() !== '' && !d.includes('[Sous-crit√®re') && !d.includes('[D√©tail')
                            );
                            maxScore += validDetails.length;
                        } else {
                            // Sinon, crit√®re normal = 2 points max
                            maxScore += 2;
                        }
                    });
                    return maxScore;
                }
                
                if (isNewFormat) {
                    // Pour le nouveau format, calculer dynamiquement
                    Object.keys(data.sections).forEach(sectionKey => {
                        const section = data.sections[sectionKey];
                        maxScores[sectionKey] = calculateSectionMaxScore(section.criteria);
                        maxTotal += maxScores[sectionKey];
                    });
                } else {
                    // Format traditionnel
                    maxScores.anamnese = calculateSectionMaxScore(data.sections.anamnese.criteria);
                    maxScores.examen = calculateSectionMaxScore(data.sections.examen.criteria);
                    maxScores.management = calculateSectionMaxScore(data.sections.management.criteria);
                    maxScores.communication = 20;
                    maxTotal = maxScores.anamnese + maxScores.examen + maxScores.management + maxScores.communication;
                }

                // Construction du HTML
                let html = '<!DOCTYPE html>\n<html lang="fr">\n<head>\n';
                html += '    <meta charset="UTF-8">\n';
                html += '    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n';
                html += '    <title>' + data.title + ' - Grille ECOS</title>\n';
                
                // Styles CSS
                html += '    <style>\n';
                html += '        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }\n';
                html += '        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }\n';
                html += '        .header { background: #2c5aa0; color: white; padding: 15px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; }\n';
                html += '        .section { margin-bottom: 30px; border: 2px solid #ddd; border-radius: 8px; overflow: hidden; background-color: #ffffff; }\n';
                html += '        .section-header { background: #f8f9fa; padding: 15px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }\n';
                html += '        .section-content { padding: 15px; background-color: #ffffff; }\n';
                html += '        .header-row { display: grid; grid-template-columns: 2fr 80px 80px 80px 80px; gap: 10px; padding: 10px 0; border-bottom: 2px solid #ddd; font-weight: bold; text-align: center; color: #333333; }\n';
                html += '        .header-row.communication-header { grid-template-columns: 2fr 80px 80px 80px 80px 80px; }\n';
                html += '        .header-row div:first-child { text-align: left; }\n';
                html += '        .criteria-row { display: grid; grid-template-columns: 2fr 80px 80px 80px 80px; gap: 10px; align-items: start; padding: 15px 0 15px 5px; border-bottom: 1px solid #eeeeee; }\n';
                html += '        .criteria-row:last-child { border-bottom: none; }\n';
                html += '        .criteria-text { font-weight: 500; }\n';
                html += '        .sub-criteria { font-size: 0.9em; color: #333; margin-top: 5px; padding-left: 18px; line-height: 1.2; }\n';
                html += '        .details-with-checkboxes { margin-top: 8px; }\n';
                html += '        .detail-row { display: grid; grid-template-columns: 1fr 100px; align-items: center; padding: 2px 0 2px 18px; gap: 10px; line-height: 1.1; }\n';
                html += '        .detail-text { font-size: 0.9em; color: #333; }\n';
                html += '        .patient-response-highlight { color: rgb(44, 90, 160) !important; }\n';
                html += '        .detail-text .patient-response-highlight { color: rgb(44, 90, 160) !important; }\n';
                html += '        .criteria-detail .patient-response-highlight { color: rgb(44, 90, 160) !important; }\n';
                html += '        .detail-checkboxes { text-align: center; }\n';
                html += '        .detail-checkbox input[type="checkbox"] { cursor: pointer; transform: scale(1.1); }\n';
                html += '        .patient-response { font-size: 0.9em; color: rgb(44, 90, 160); font-weight: 500; }\n';
                html += '        .exemples-phrases { margin-top: 8px; padding-left: 20px; }\n';
                html += '        .exemple-phrase { font-size: 0.9em; color: rgba(112, 188, 123, 0.95); font-style: italic; line-height: 1.4; margin: 3px 0; }\n';
                html += '        .checkbox-group { text-align: center; }\n';
                html += '        .points-display { text-align: center; font-weight: bold; color: #2c5aa0; font-size: 18px; }\n';
                html += '        .scoring-rule { font-size: 0.85em; color: #888; font-style: italic; margin-top: 8px; padding-left: 20px; }\n';
                html += '        .criteria-subheader { background: #fffbe6; padding: 10px 15px; margin: 10px 0 5px 0; border-left: 4px solid #faad14; font-weight: bold; color: #8b6914; }\n';
                html += '        input[type="radio"] { cursor: pointer; transform: scale(1.2); }\n';
                html += '        input[type="radio"]:disabled { opacity: 0.3; cursor: not-allowed; }\n';
                html += '        .score { font-weight: bold; color: hsl(216, 57%, 40%); font-size: 18px; }\n';
                html += '        .total-sections { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; margin-bottom: 30px; }\n';
                html += '        .total-section { display: flex; flex-direction: column; justify-content: space-between; text-align: center; background: #f0f8ff; border: 1px solid #ddd; border-radius: 8px; transition: all 0.3s; }\n';
                html += '        .total-label { background: #f8f9fa; padding: 5px; font-weight: bold; font-size: 20px; border-bottom: 1px solid #ddd; }\n';
                html += '        .total-body { flex: 1; display: flex; align-items: center; justify-content: center; padding: 5px; }\n';
                html += '        .total-pourcent-body { flex: 1; padding: 10px; }\n';
                html += '        .total-score, .total-note-globale { font-size: 56px; font-weight: bold; line-height: 1; }\n';
                html += '        .total-pourcent-sections { display: flex; flex-wrap: nowrap; gap: 10px; height: 100%; align-items: stretch; }\n';
                html += '        .total-pourcent-section { flex: 1 1 auto; min-width: 0; display: flex; flex-direction: column; text-align: center; background: #416caa; padding: 10px; border-radius: 5px; transition: all 0.3s; border: none; }\n';
                html += '        .total-pourcent-section:last-child { border-right: none; }\n';
                html += '        .total-section-label { color: #eeeeee; font-size: 14px; font-weight: normal; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n';
                html += '        .pourcent-body { flex: 1; display: flex; align-items: center; justify-content: center; }\n';
                html += '        .total-pourcent-value { font-weight: bold; font-size: 28px; line-height: 1; color: white; transition: all 0.3s; }\n';
                html += '        .note-a { background-color: #e6f4ea; color: #2c974b; }\n';
                html += '        .note-a.total-pourcent-section { background-color: #2c974b; }\n';
                html += '        .note-b { background-color: #e9f3fd; color: #4e9cf0; }\n';
                html += '        .note-b.total-pourcent-section { background-color: #4e9cf0; }\n';
                html += '        .note-c { background-color: #fdf5e6; color: #f0ad4e; }\n';
                html += '        .note-c.total-pourcent-section { background-color: #f0ad4e; }\n';
                html += '        .note-d { background-color: #fceee3; color: #e67e22; }\n';
                html += '        .note-d.total-pourcent-section { background-color: #e67e22; }\n';
                html += '        .note-e { background-color: #fbeaea; color: #d9534f; }\n';
                html += '        .note-e.total-pourcent-section { background-color: #d9534f; }\n';
                html += '        .note-neutral { background-color: #f0f8ff; color: #2c5aa0; }\n';
                html += '        .note-neutral.total-pourcent-section { background-color: #6B8BC3; }\n';
                html += '        .note-a.total-pourcent-body { background-color: #e6f4ea; }\n';
                html += '        .note-b.total-pourcent-body { background-color: #e9f3fd; }\n';
                html += '        .note-c.total-pourcent-body { background-color: #fdf5e6; }\n';
                html += '        .note-d.total-pourcent-body { background-color: #fceee3; }\n';
                html += '        .note-e.total-pourcent-body { background-color: #fbeaea; }\n';
                html += '        .note-neutral.total-pourcent-body { background-color: #f0f8ff; }\n';
                html += '        /* Styles pour les sections avec coloration selon le score */\n';
                html += '        .section.note-a { border-color: #2c974b; }\n';
                html += '        .section.note-a .section-header { background-color: #e6f4ea; color: #2c974b; }\n';
                html += '        .section.note-b { border-color: #4e9cf0; }\n';
                html += '        .section.note-b .section-header { background-color: #e9f3fd; color: #4e9cf0; }\n';
                html += '        .section.note-c { border-color: #f0ad4e; }\n';
                html += '        .section.note-c .section-header { background-color: #fdf5e6; color: #f0ad4e; }\n';
                html += '        .section.note-d { border-color: #e67e22; }\n';
                html += '        .section.note-d .section-header { background-color: #fceee3; color: #e67e22; }\n';
                html += '        .section.note-e { border-color: #d9534f; }\n';
                html += '        .section.note-e .section-header { background-color: #fbeaea; color: #d9534f; }\n';
                html += '        .section.note-neutral { border-color: #ddd; }\n';
                html += '        .section.note-neutral .section-header { background-color: #f8f9fa; color: #333333; }\n';
                html += '        /* Styles pour les crit√®res individuels */\n';
                html += '        .criteria-row.score-2 { background-color: rgba(44, 151, 75, 0.1); }\n';
                html += '        .criteria-row.score-2 .criteria-text { color: #2c974b; }\n';
                html += '        .criteria-row.score-max { background-color: rgba(44, 151, 75, 0.1); }\n';
                html += '        .criteria-row.score-max .criteria-text { color: #2c974b; }\n';
                html += '        .criteria-row.score-1 { background-color: rgba(240, 173, 78, 0.1); }\n';
                html += '        .criteria-row.score-1 .criteria-text { color: #f0ad4e; }\n';
                html += '        .criteria-row.score-0 { background-color: rgba(217, 83, 79, 0.1); }\n';
                html += '        .criteria-row.score-0 .criteria-text { color: #d9534f; }\n';
                html += '        .criteria-row:not(.score-0):not(.score-1):not(.score-2):not(.score-max) .criteria-text { color: #000; }\n';
                html += '        /* Styles suppl√©mentaires pour les scores plus √©lev√©s */\n';
                html += '        .criteria-row.score-3 { background-color: rgba(44, 151, 75, 0.1); }\n';
                html += '        .criteria-row.score-3 .criteria-text { color: #2c974b; }\n';
                html += '        .criteria-row.score-4 { background-color: rgba(44, 151, 75, 0.1); }\n';
                html += '        .criteria-row.score-4 .criteria-text { color: #2c974b; }\n';
                html += '        .criteria-row.score-5 { background-color: rgba(44, 151, 75, 0.1); }\n';
                html += '        .criteria-row.score-5 .criteria-text { color: #2c974b; }\n';
                html += '        .communication-section.score-a { background-color: rgba(44, 151, 75, 0.1); }\n';
                html += '        .communication-section.score-a .communication-text { color: #2c974b; }\n';
                html += '        .communication-section.score-b { background-color: rgba(78, 156, 240, 0.1); }\n';
                html += '        .communication-section.score-b .communication-text { color: #4e9cf0; }\n';
                html += '        .communication-section.score-c { background-color: rgba(240, 173, 78, 0.1); }\n';
                html += '        .communication-section.score-c .communication-text { color: #f0ad4e; }\n';
                html += '        .communication-section.score-d { background-color: rgba(230, 126, 34, 0.1); }\n';
                html += '        .communication-section.score-d .communication-text { color: #e67e22; }\n';
                html += '        .communication-section.score-e { background-color: rgba(217, 83, 79, 0.1); }\n';
                html += '        .communication-section.score-e .communication-text { color: #d9534f; }\n';
                html += '        .grade-scale { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }\n';
                html += '        .grade-scale h3 { margin-top: 0; }\n';
                html += '        .grade-row { display: flex; justify-content: space-between; padding: 5px 0; }\n';
                html += '        .missing-items { display: none !important; }\n';
                html += '        .missing-items h3 { margin-top: 0; }\n';
                html += '        .missing-item { color: #dc3545; font-weight: bold; }\n';
                html += '        .redflags-main-section { margin-top: 30px; padding: 20px; background: #fff5f5; border-radius: 8px; border: 1px solid #f5c6cb; }\n';
                html += '        .redflags-main-section h3 { margin-top: 0; border-bottom: 2px solid #f5c6cb; padding-bottom: 10px; }\n';
                html += '        .redflags-category-section { margin: 15px 0; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #dc3545; }\n';
                html += '        .annexes { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd; }\n';
                html += '        .annexes h3 { margin-top: 0; color: #2c5aa0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }\n';
                html += '        .annexes-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }\n';
                html += '        .annexe-item { padding: 15px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; }\n';
                html += '        .annexe-title { font-weight: bold; color: #2c5aa0; margin-bottom: 8px; font-size: 16px; }\n';
                html += '        .annexe-description { color: #666; font-style: italic; margin-bottom: 10px; font-size: 14px; }\n';
                html += '        .annexe-image { text-align: center; margin: 10px 0; }\n';
                html += '        .annexe-image img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }\n';
                html += '        .annexe-document { background: #f0f8ff; padding: 10px; border-radius: 4px; border-left: 4px solid #2c5aa0; white-space: pre-wrap; font-family: "Courier New", monospace; font-size: 13px; }\n';
                html += '        \n';
                html += '        /* Styles pour le sc√©nario de la patiente standardis√©e */\n';
                html += '        .annexe-scenario { grid-column: 1 / -1; max-width: none; }\n';
                html += '        .annexe-scenario-content { padding: 15px; background: #fafafa; border-radius: 4px; }\n';
                html += '        .scenario-info { background: #e8f4f8; padding: 10px 15px; border-radius: 4px; margin-bottom: 15px; font-size: 15px; }\n';
                html += '        .scenario-section { margin-bottom: 20px; }\n';
                html += '        .scenario-subsection { margin-bottom: 15px; }\n';
                html += '        .scenario-subsection strong { color: #2c5aa0; }\n';
                html += '        .scenario-section h4 { color: #2c5aa0; margin: 15px 0 10px 0; font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }\n';
                html += '        .scenario-section ul { margin: 10px 0; padding-left: 25px; }\n';
                html += '        .scenario-section li { margin: 5px 0; line-height: 1.5; }\n';
                html += '        .scenario-subsection { margin: 10px 0 15px 0; }\n';
                html += '        .scenario-subsection strong { color: #555; }\n';
                html += '        .scenario-subsection ul { margin-top: 5px; }\n';
                html += '        \n';
                html += '        /* Styles pour les interventions de l\'expert */\n';
                html += '        .annexe-interventions { grid-column: 1 / -1; max-width: none; }\n';
                html += '        .annexe-interventions-content { padding: 15px; }\n';
                html += '        .intervention-item { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 12px; margin-bottom: 12px; }\n';
                html += '        .intervention-header { font-size: 15px; margin-bottom: 8px; color: #856404; }\n';
                html += '        .intervention-moment { font-weight: normal; font-style: italic; color: #666; }\n';
                html += '        .intervention-instruction { margin: 8px 0; color: #333; }\n';
                html += '        .intervention-message { background: #fff; padding: 8px 12px; border-left: 3px solid #ffc107; font-style: italic; color: #721c24; margin-top: 8px; }\n';
                html += '        \n';
                html += '        /* Styles pour les informations de l\'expert */\n';
                html += '        .annexe-informations-expert { grid-column: 1 / -1; max-width: none; }\n';
                html += '        .annexe-informations-content { padding: 15px; background: #f5f5f5; border-radius: 4px; }\n';
                html += '        .info-section { margin-bottom: 20px; }\n';
                html += '        .info-section:last-child { margin-bottom: 0; }\n';
                html += '        .info-section h4 { color: #2c5aa0; margin: 0 0 10px 0; font-size: 16px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }\n';
                html += '        .info-section h5 { color: #4a7ba7; margin: 15px 0 8px 0; font-size: 14px; font-weight: 600; }\n';
                html += '        .info-section p { margin: 10px 0; line-height: 1.6; }\n';
                html += '        .info-section ul { margin: 10px 0; padding-left: 25px; }\n';
                html += '        .info-section li { margin: 5px 0; line-height: 1.5; }\n';
                html += '        \n';
                html += '        /* Styles pour les diagnostics diff√©rentiels dans annexes */\n';
                html += '        .annexe-dd-section { grid-column: 1 / -1; max-width: none; }\n';
                html += '        .annexe-dd-content { padding: 15px; background: #fff5f0; border-radius: 4px; }\n';
                html += '        .dd-category { margin-bottom: 20px; }\n';
                html += '        .dd-category:last-child { margin-bottom: 0; }\n';
                html += '        .dd-category h4 { color: #a92117; margin: 0 0 15px 0; font-size: 16px; border-bottom: 1px solid #e0d0c8; padding-bottom: 5px; }\n';
                html += '        .dd-items { display: flex; flex-direction: column; gap: 15px; }\n';
                html += '        .dd-item { background: white; border: 1px solid #e5e5e5; border-radius: 4px; padding: 12px; }\n';
                html += '        .dd-item-header { margin-bottom: 8px; }\n';
                html += '        .dd-diagnosis { color: #a92117; font-weight: 600; font-size: 15px; }\n';
                html += '        .dd-cause { margin-bottom: 8px; line-height: 1.5; font-size: 14px; }\n';
                html += '        .dd-test { font-size: 14px; margin-top: 5px; }\n';
                html += '        \n';
                html += '        /* Styles pour la th√©orie pratique */\n';
                html += '        .annexe-theorie-pratique { grid-column: 1 / -1; max-width: none; }\n';
                html += '        .annexe-theorie-content { padding: 15px; background: #f0f5ff; border-radius: 4px; }\n';
                html += '        .theorie-text { line-height: 1.6; color: #333; }\n';
                html += '        .theorie-section { margin-bottom: 20px; }\n';
                html += '        .theorie-section:last-child { margin-bottom: 0; }\n';
                html += '        .theorie-section h4 { color: #1a4b84; margin: 0 0 10px 0; font-size: 16px; }\n';
                html += '        .theorie-section p { margin: 10px 0; line-height: 1.6; }\n';
                html += '        .theorie-section ul { margin: 10px 0; padding-left: 25px; }\n';
                html += '        .theorie-section li { margin: 5px 0; line-height: 1.5; }\n';
                html += '        /* Styles pour rappels th√©rapeutiques et examens compl√©mentaires */\n';
                html += '        .annexe-rappels-therapeutiques, .annexe-examens-complementaires { grid-column: 1 / -1; max-width: none; }\n';
                html += '        .rappels-list, .examens-list { margin: 0; padding-left: 25px; }\n';
                html += '        .rappels-list li, .examens-list li { margin: 8px 0; line-height: 1.6; color: #333; }\n';
                html += '        .annexe-rappels-therapeutiques .annexe-title { color: #998800; }\n';
                html += '        .annexe-examens-complementaires .annexe-title { color: #346929; }\n';
                html += '        \n';
                html += '        /* Styles pour le tableau clinique */\n';
                html += '        .tableau-clinique { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }\n';
                html += '        .tableau-clinique thead { background-color: #2c5aa0; color: white; }\n';
                html += '        .tableau-clinique th { padding: 10px; text-align: left; border: 1px solid #ddd; }\n';
                html += '        .tableau-clinique tbody tr:nth-child(even) { background-color: #f9f9f9; }\n';
                html += '        .tableau-clinique tbody tr:hover { background-color: #e8f4f8; }\n';
                html += '        .tableau-clinique td { padding: 8px; border: 1px solid #ddd; }\n';
                html += '        \n';
                html += '        .communication-section { display: grid; grid-template-columns: 2fr 80px 80px 80px 80px 80px; gap: 10px; align-items: start; padding: 15px 0 15px 5px; border-bottom: 1px solid #eee; }\n';
                html += '        .communication-text { font-weight: 500; }\n';
                html += '        .communication-desc { font-size: 0.85em; color: #666; margin-top: 5px; font-style: italic; }\n';
                html += '        /* Section Cl√¥ture */\n';
                html += '        .cloture-section { margin-bottom: 20px; }\n';
                html += '        .cloture-section .section-header { background-color: #f0f4f8; }\n';
                html += '        .cloture-item { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }\n';
                html += '        .cloture-title { color: #2c5aa0; margin: 0 0 10px 0; font-size: 16px; font-weight: bold; }\n';
                html += '        .cloture-content { color: #333; line-height: 1.6; font-style: italic; }\n';
                html += '        .cloture-content-green { color: rgb(112, 188, 123); font-weight: 500; }\n';
                html += '        .communication-desc-detail { font-size: 0.8em; color: #666; margin-left: 20px; font-style: normal; }\n';
                html += '        .vital-signs { margin-top: 10px; margin-bottom: 0px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 0.9em; }\n';
                html += '        .vital-sign { text-align: center; background: #416caa; padding: 10px; border-radius: 5px; }\n';
                html += '        .vital-sign-label { color: #eeeeee; }\n';
                html += '        .vital-sign-value { color: rgb(255, 255, 255); margin-top: 2px; }\n';
                html += '        .dd-section { background: #f0f8ff; padding: 15px; margin: 0 0 10px 0; border-radius: 5px; }\n';
                html += '        .dd-title { font-weight: bold; margin-bottom: 10px; color: #2c5aa0; }\n';
                html += '        .dd-category { margin: 10px 0; font-weight: bold; color: #2c5aa0; }\n';
                html += '        .dd-item { margin-left: 20px; margin-top: 5px; font-weight: bold; color: rgb(169, 34, 23); }\n';
                html += '        .dd-test { color: #666; font-style: italic; margin-left: 10px; }\n';
                html += '        .therapy-section { background: rgba(255, 250, 230, 0.4); padding: 10px 10px 0 20px; margin: 0; border-radius: 5px; color: #000; }\n';
                html += '        .therapy-title { font-weight: bold; margin-bottom: 5px; color: #998800; }\n';
                html += '        .redflags-section { background: #fff5f5; padding: 10px; margin: 5px 0; border-radius: 5px; }\n';
                html += '        .redflags-title { font-weight: bold; margin-bottom: 8px; color: #dc3545; }\n';
                html += '        .redflags-item { margin-bottom: 6px; padding-left: 22px; }\n';
                html += '        .redflags-text { color: #dc3545; font-weight: 500; }\n';
                html += '        .redflags-description { color: #666; font-size: 0.9em; margin-top: 2px; margin-left: 20px; }\n';
                html += '        .annexes { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd; }\n';
                html += '        .annexes h3 { margin-top: 0; color: #2c5aa0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }\n';
                html += '        .annexes-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }\n';
                html += '        .annexe-item { padding: 15px; background: white; border-radius: 5px; border: 1px solid #e0e0e0; }\n';
                html += '        .annexe-title { font-weight: bold; color: #2c5aa0; margin-bottom: 8px; font-size: 16px; }\n';
                html += '        .annexe-description { color: #666; font-style: italic; margin-bottom: 10px; font-size: 14px; }\n';
                html += '        .annexe-image { text-align: center; margin: 10px 0; }\n';
                html += '        .annexe-image img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }\n';
                html += '        .annexe-document { background: #f0f8ff; padding: 10px; border-radius: 4px; border-left: 4px solid #2c5aa0; white-space: pre-wrap; font-family: "Courier New", monospace; font-size: 13px; }\n';
                html += '        \n';
                html += '        /* MINUTEUR */\n';
                html += '        .timer-container {\n';
                html += '            position: fixed;\n';
                html += '            top: 20px;\n';
                html += '            left: 20px;\n';
                html += '            background: rgba(255, 255, 255, 0.75);\n';
                html += '            border: 3px solid #2c5aa0;\n';
                html += '            border-radius: 15px;\n';
                html += '            padding: 8px;\n';
                html += '            box-shadow: 0 4px 20px rgba(0,0,0,0.2);\n';
                html += '            z-index: 1000;\n';
                html += '            text-align: center;\n';
                html += '            min-width: 200px;\n';
                html += '        }\n';
                html += '        .timer-display {\n';
                html += '            font-size: 40px;\n';
                html += '            font-weight: bold;\n';
                html += '            color: #2c5aa0;\n';
                html += '            margin-bottom: 15px;\n';
                html += '            font-family: \'Courier New\', monospace;\n';
                html += '        }\n';
                html += '        .timer-controls {\n';
                html += '            display: flex;\n';
                html += '            gap: 10px;\n';
                html += '            justify-content: center;\n';
                html += '            margin-top: 10px;\n';
                html += '        }\n';
                html += '        .timer-btn {\n';
                html += '            padding: 8px 16px;\n';
                html += '            border: none;\n';
                html += '            border-radius: 5px;\n';
                html += '            cursor: pointer;\n';
                html += '            font-weight: bold;\n';
                html += '            transition: all 0.2s;\n';
                html += '            font-size: 14px;\n';
                html += '        }\n';
                html += '        .start-btn {\n';
                html += '            background: #28a745;\n';
                html += '            color: white;\n';
                html += '        }\n';
                html += '        .start-btn:hover {\n';
                html += '            background: #218838;\n';
                html += '        }\n';
                html += '        .stop-btn {\n';
                html += '            background: #dc3545;\n';
                html += '            color: white;\n';
                html += '        }\n';
                html += '        .stop-btn:hover {\n';
                html += '            background: #c82333;\n';
                html += '        }\n';
                html += '        .reset-btn {\n';
                html += '            background: #6c757d;\n';
                html += '            color: white;\n';
                html += '        }\n';
                html += '        .reset-btn:hover {\n';
                html += '            background: #5a6268;\n';
                html += '        }\n';
                html += '        .timer-btn:disabled {\n';
                html += '            opacity: 0.5;\n';
                html += '            cursor: not-allowed;\n';
                html += '        }\n';
                html += '        .timer-btn:disabled:hover {\n';
                html += '            background: #6c757d;\n';
                html += '        }\n';
                html += '        .timer-status {\n';
                html += '            font-size: 14px;\n';
                html += '            font-weight: bold;\n';
                html += '            margin-top: 10px;\n';
                html += '            padding: 5px 10px;\n';
                html += '            border-radius: 5px;\n';
                html += '        }\n';
                html += '        .status-running {\n';
                html += '            background: #e3f2fd;\n';
                html += '            color: #1976d2;\n';
                html += '        }\n';
                html += '        .status-warning {\n';
                html += '            background: #fff3cd;\n';
                html += '            color: #ff6f00;\n';
                html += '        }\n';
                html += '        .status-finished {\n';
                html += '            background: #f8d7da;\n';
                html += '            color: #721c24;\n';
                html += '        }\n';
                html += '        .timer-warning {\n';
                html += '            animation: pulse-warning 2s infinite;\n';
                html += '        }\n';
                html += '        .timer-critical {\n';
                html += '            animation: pulse-critical 1s infinite;\n';
                html += '        }\n';
                html += '        @keyframes pulse-warning {\n';
                html += '            0%, 100% { transform: scale(1); }\n';
                html += '            50% { transform: scale(1.05); }\n';
                html += '        }\n';
                html += '        @keyframes pulse-critical {\n';
                html += '            0%, 100% { transform: scale(1); border-color: #dc3545; }\n';
                html += '            50% { transform: scale(1.1); border-color: #ff0000; }\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* COLORATION POST-MINUTEUR */\n';
                html += '        .criteria-zero-points {\n';
                html += '            background-color: rgba(251, 234, 234, 0.6) !important;\n';
                html += '        }\n';
                html += '        .criteria-one-point {\n';
                html += '            background-color: rgba(253, 245, 230, 0.6) !important;\n';
                html += '        }\n';
                html += '        .criteria-full-points {\n';
                html += '            background-color: rgba(230, 244, 234, 0.6) !important;\n';
                html += '        }\n';
                html += '        .criteria-not-answered {\n';
                html += '            background-color: rgba(240, 248, 255, 0.6) !important;\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* COLORATION COMMUNICATION */\n';
                html += '        .communication-note-a {\n';
                html += '            background-color: rgba(230, 244, 234, 0.6) !important;\n';
                html += '        }\n';
                html += '        .communication-note-b {\n';
                html += '            background-color: rgba(233, 243, 253, 0.6) !important;\n';
                html += '        }\n';
                html += '        .communication-note-c {\n';
                html += '            background-color: rgba(253, 245, 230, 0.6) !important;\n';
                html += '        }\n';
                html += '        .communication-note-d {\n';
                html += '            background-color: rgba(252, 238, 227, 0.6) !important;\n';
                html += '        }\n';
                html += '        .communication-note-e {\n';
                html += '            background-color: rgba(251, 234, 234, 0.6) !important;\n';
                html += '        }\n';
                html += '        .communication-not-answered {\n';
                html += '            background-color: rgba(240, 248, 255, 0.6) !important;\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* MODE SELECTOR */\n';
                html += '        .mode-selector {\n';
                html += '            position: fixed;\n';
                html += '            top: 20px;\n';
                html += '            right: 20px;\n';
                html += '            background: white;\n';
                html += '            border: 2px solid #2c5aa0;\n';
                html += '            border-radius: 30px;\n';
                html += '            padding: 5px;\n';
                html += '            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n';
                html += '            z-index: 1001;\n';
                html += '            display: flex;\n';
                html += '            gap: 5px;\n';
                html += '        }\n';
                html += '        .mode-button {\n';
                html += '            padding: 8px 16px;\n';
                html += '            border: none;\n';
                html += '            border-radius: 25px;\n';
                html += '            cursor: pointer;\n';
                html += '            font-weight: 500;\n';
                html += '            transition: all 0.3s;\n';
                html += '            background: transparent;\n';
                html += '            color: #2c5aa0;\n';
                html += '        }\n';
                html += '        .mode-button.active {\n';
                html += '            background: #2c5aa0;\n';
                html += '            color: white;\n';
                html += '        }\n';
                html += '        .mode-button:hover:not(.active) {\n';
                html += '            background: #e8f0fe;\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* Mode-specific hiding and showing - CORRIG√â */\n';
                html += '        .revision-mode .timer-container {\n';
                html += '            display: none !important;\n';
                html += '        }\n';
                html += '        .exam-mode .timer-container {\n';
                html += '            display: block !important;\n';
                html += '        }\n';
                html += '        .exam-mode .revision-controls {\n';
                html += '            display: none !important;\n';
                html += '        }\n';
                html += '        /* Masquer les descriptions et titres d\'annexes en mode examen quand le timer est actif */\n';
                html += '        .exam-mode.timer-running .annexe-item .annexe-title,\n';
                html += '        .exam-mode.timer-running .annexe-item .annexe-description {\n';
                html += '            display: none !important;\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* Revision controls */\n';
                html += '        .revision-controls {\n';
                html += '            position: fixed;\n';
                html += '            top: 70px;\n';
                html += '            right: 20px;\n';
                html += '            background: white;\n';
                html += '            border: 2px solid #4CAF50;\n';
                html += '            border-radius: 30px;\n';
                html += '            padding: 5px;\n';
                html += '            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n';
                html += '            display: flex;\n';
                html += '            gap: 5px;\n';
                html += '            z-index: 1000;\n';
                html += '        }\n';
                html += '        .lacune-button {\n';
                html += '            background: transparent;\n';
                html += '            color: #4CAF50;\n';
                html += '            border: none;\n';
                html += '            padding: 8px 16px;\n';
                html += '            border-radius: 25px;\n';
                html += '            cursor: pointer;\n';
                html += '            font-size: 14px;\n';
                html += '            font-weight: 500;\n';
                html += '            transition: all 0.3s;\n';
                html += '        }\n';
                html += '        .lacune-button:hover {\n';
                html += '            background: #4CAF50;\n';
                html += '            color: white;\n';
                html += '        }\n';
                html += '        .reset-revision-button {\n';
                html += '            background: transparent;\n';
                html += '            color: #6c757d;\n';
                html += '            border: none;\n';
                html += '            padding: 8px 16px;\n';
                html += '            border-radius: 25px;\n';
                html += '            cursor: pointer;\n';
                html += '            font-size: 14px;\n';
                html += '            font-weight: 500;\n';
                html += '            transition: all 0.3s;\n';
                html += '        }\n';
                html += '        .reset-revision-button:hover {\n';
                html += '            background: #6c757d;\n';
                html += '            color: white;\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* Styles pour les commentaires discrets */\n';
                html += '        .comment-button { \n';
                html += '            background: none; \n';
                html += '            border: none; \n';
                html += '            color: #2c5aa0; \n';
                html += '            cursor: pointer; \n';
                html += '            font-size: 14px; \n';
                html += '            padding: 2px 6px; \n';
                html += '            margin-left: 8px; \n';
                html += '            border-radius: 3px; \n';
                html += '            opacity: 0.6;\n';
                html += '            transition: all 0.2s;\n';
                html += '        }\n';
                html += '        .comment-button:hover { opacity: 1; background: rgba(44, 90, 160, 0.1); }\n';
                html += '        .comment-button.has-content { opacity: 1; color: #d9534f; }\n';
                html += '        .criterion-comment-section { \n';
                html += '            display: none; \n';
                html += '            margin: 8px 0 12px 20px; \n';
                html += '            padding: 10px; \n';
                html += '            background: #fafafa; \n';
                html += '            border-radius: 4px;\n';
                html += '            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n';
                html += '        }\n';
                html += '        .criterion-comment-section.show { display: block; }\n';
                html += '        .section-comment-button {\n';
                html += '            background: rgba(44, 90, 160, 0.1);\n';
                html += '            border: 1px solid #2c5aa0;\n';
                html += '            color: #2c5aa0;\n';
                html += '            cursor: pointer;\n';
                html += '            font-size: 12px;\n';
                html += '            padding: 4px 8px;\n';
                html += '            margin-left: 10px;\n';
                html += '            border-radius: 15px;\n';
                html += '            opacity: 0.8;\n';
                html += '            transition: all 0.2s;\n';
                html += '            font-weight: 500;\n';
                html += '        }\n';
                html += '        .section-comment-button:hover { \n';
                html += '            opacity: 1; \n';
                html += '            background: rgba(44, 90, 160, 0.2); \n';
                html += '            transform: scale(1.05);\n';
                html += '        }\n';
                html += '        .section-comment-button.has-content { \n';
                html += '            background: rgba(220, 53, 69, 0.1);\n';
                html += '            border-color: #d9534f;\n';
                html += '            color: #d9534f; \n';
                html += '        }\n';
                html += '        .section-comment-section { \n';
                html += '            display: none;\n';
                html += '            margin: 20px 0; \n';
                html += '            padding: 12px; \n';
                html += '            background: #f8f9fa; \n';
                html += '            border-radius: 6px;\n';
                html += '        }\n';
                html += '        .section-comment-section.show { display: block; }\n';
                html += '        .section-comment-section.global { \n';
                html += '            display: block; \n';
                html += '            background: #f0f8ff; \n';
                html += '        }\n';
                html += '        /* La section commentaire global reste toujours visible sauf √† l\'impression */\n';
                html += '        .comment-textarea { \n';
                html += '            width: calc(100% - 0px); \n';
                html += '            min-height: 26px; \n';
                html += '            padding: 5px; \n';
                html += '            margin-right: 0px;\n';
                html += '            border: 1px solid #ddd; \n';
                html += '            border-radius: 3px; \n';
                html += '            font-family: Arial, sans-serif;\n';
                html += '            font-size: 12px; \n';
                html += '            resize: vertical;\n';
                html += '            box-sizing: border-box;\n';
                html += '            overflow-y: hidden;\n';
                html += '            color: #7b3f00;\n';
                html += '            height: 26px;\n';
                html += '        }\n';
                html += '        .section-comment-section .comment-textarea {\n';
                html += '            min-height: 28px;\n';
                html += '            font-size: 14px;\n';
                html += '            height: 28px;\n';
                html += '        }\n';
                html += '        .section-comment-section.global .comment-textarea {\n';
                html += '            min-height: 30px;\n';
                html += '            font-size: 16px;\n';
                html += '            height: 30px;\n';
                html += '        }\n';
                html += '        .comment-textarea:focus {\n';
                html += '            outline: none;\n';
                html += '            border-color: #2c5aa0;\n';
                html += '            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* Masquer les boutons √† l\'impression */\n';
                html += '        @media print {\n';
                html += '            .comment-button,\n';
                html += '            .section-comment-button {\n';
                html += '                display: none !important;\n';
                html += '            }\n';
                html += '            .criterion-comment-section:not(.has-content),\n';
                html += '            .section-comment-section:not(.has-content) {\n';
                html += '                display: none !important;\n';
                html += '            }\n';
                html += '            .criterion-comment-section.has-content,\n';
                html += '            .section-comment-section.has-content {\n';
                html += '                display: block !important;\n';
                html += '                page-break-inside: avoid;\n';
                html += '            }\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* Styles pour les lacunes */\n';
                html += '        .lacune-rouge {\n';
                html += '            background-color: #ffebee !important;\n';
                html += '        }\n';
                html += '        .lacune-orange {\n';
                html += '            background-color: #fff3e0 !important;\n';
                html += '        }\n';
                html += '        .lacune-verte {\n';
                html += '            background-color: #e8f5e8 !important;\n';
                html += '        }\n';
                html += '        \n';
                html += '        /* Bouton d\'impression */\n';
                html += '        .print-button {\n';
                html += '            position: fixed;\n';
                html += '            bottom: 20px;\n';
                html += '            right: 20px;\n';
                html += '            background: #2c5aa0;\n';
                html += '            color: white;\n';
                html += '            border: none;\n';
                html += '            padding: 15px 20px;\n';
                html += '            border-radius: 50px;\n';
                html += '            cursor: pointer;\n';
                html += '            font-size: 16px;\n';
                html += '            box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);\n';
                html += '            z-index: 1000;\n';
                html += '        }\n';
                html += '        .print-button:hover {\n';
                html += '            background: #1e3f70;\n';
                html += '        }\n';
                html += '        @media print {\n';
                html += '            /* Masquer les √©l√©ments interactifs */\n';
                html += '            .print-button, .mode-selector, .revision-controls, .missing-items { display: none !important; }\n';
                html += '            .comment-button, .section-comment-button { display: none !important; }\n';
                html += '            /* IMPORTANT: MASQUER LE MINUTEUR √† L\'IMPRESSION! */\n';
                html += '            .timer-container {\n';
                html += '                display: none !important;\n';
                html += '                visibility: hidden !important;\n';
                html += '                position: absolute !important;\n';
                html += '                left: -9999px !important;\n';
                html += '            }\n';
                html += '            /* Supprimer les bordures gauches √† l\'impression */\n';
                html += '            .criteria-row { border-left: none !important; }\n';
                html += '            .communication-section { border-left: none !important; }\n';
                html += '            .lacune-rouge { border-left: none !important; }\n';
                html += '            .lacune-orange { border-left: none !important; }\n';
                html += '            .lacune-verte { border-left: none !important; }\n';
                html += '            \n';
                html += '            /* Gestion des commentaires √† l\'impression */\n';
                html += '            .criterion-comment-section:not(.has-content),\n';
                html += '            .section-comment-section:not(.has-content) { display: none !important; }\n';
                html += '            .section-comment-section.global:not(.has-content) { display: none !important; }\n';
                html += '            .criterion-comment-section.has-content,\n';
                html += '            .section-comment-section.has-content { display: block !important; }\n';
                html += '            \n';
                html += '            /* Les textareas conservent leur hauteur actuelle √† l\'impression */\n';
                html += '            .comment-textarea {\n';
                html += '                border: 1px solid #ccc !important;\n';
                html += '                background: white !important;\n';
                html += '                padding: 4px !important;\n';
                html += '                margin-right: 15px !important;\n';
                html += '                resize: none !important;\n';
                html += '                font-size: 8pt !important;\n';
                html += '                font-family: Arial, sans-serif !important;\n';
                html += '                font-style: italic !important;\n';
                html += '                color: #333 !important;\n';
                html += '                border-radius: 2px !important;\n';
                html += '                /* Conserver la hauteur actuelle */\n';
                html += '                overflow: hidden !important;\n';
                html += '                -webkit-print-color-adjust: exact;\n';
                html += '                print-color-adjust: exact;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Sections commentaires */\n';
                html += '            .criterion-comment-section {\n';
                html += '                page-break-inside: avoid;\n';
                html += '                margin: 6px 0 8px 15px !important;\n';
                html += '                padding: 6px 8px !important;\n';
                html += '                background: #f9f9f9 !important;\n';
                html += '                border-left: 2px solid #666 !important;\n';
                html += '                border-radius: 0 3px 3px 0 !important;\n';
                html += '                box-shadow: none !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Cacher les sections de commentaires vides */\n';
                html += '            .criterion-comment-section:not(.show) {\n';
                html += '                display: none !important;\n';
                html += '            }\n';
                html += '            .criterion-comment-section.show:not(.has-content) {\n';
                html += '                display: none !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .section-comment-section {\n';
                html += '                page-break-inside: avoid;\n';
                html += '                margin: 5px 0 10px 0 !important;\n';
                html += '                padding: 6px 8px !important;\n';
                html += '                background: #f5f5f5 !important;\n';
                html += '                border: 1px solid #ccc !important;\n';
                html += '                border-radius: 4px !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Cacher toutes les sections de commentaires vides √† l\'impression */\n';
                html += '            .section-comment-section {\n';
                html += '                display: none !important;\n';
                html += '            }\n';
                html += '            /* Montrer seulement les sections avec contenu */\n';
                html += '            .section-comment-section.has-content {\n';
                html += '                display: block !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Configuration de la page */\n';
                html += '            @page { size: A4; margin: 10mm 9mm 10mm 10mm; }\n';
                html += '            body { margin: 0; background: white !important; font-size: 9pt; }\n';
                html += '            \n';
                html += '            /* Optimisation du container et des marges */\n';
                html += '            .container { \n';
                html += '                max-width: 100%; \n';
                html += '                margin: 0; \n';
                html += '                box-shadow: none; \n';
                html += '                padding: 0; \n';
                html += '                background: white !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Gestion du header pour qu\'il ne soit jamais seul */\n';
                html += '            .header { \n';
                html += '                page-break-after: avoid; \n';
                html += '                margin: 0;\n';
                html += '                margin-bottom: 10px;\n';
                html += '                padding: 10px;\n';
                html += '                font-size: 8pt;\n';
                html += '            }\n';
                html += '            .header h1 { font-size: 14pt; margin: 0 0 5px 0; }\n';
                html += '            \n';
                html += '            /* Optimisation des signes vitaux */\n';
                html += '            .vital-signs { gap: 10px; margin: 5px 0; }\n';
                html += '            .vital-sign { padding: 5px; font-size: 8pt; }\n';
                html += '            \n';
                html += '            /* Forcer l\'anamn√®se √† commencer sur la page 1 */\n';
                html += '            .section:first-of-type { page-break-before: avoid !important; }\n';
                html += '            .section:first-of-type .section-header { \n';
                html += '                page-break-after: avoid; \n';
                html += '                min-height: 20px;\n';
                html += '            }\n';
                html += '            .section:first-of-type .criteria-row:first-child { \n';
                html += '                page-break-before: avoid !important; \n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Les autres sections peuvent se diviser si n√©cessaire */\n';
                html += '            .section { \n';
                html += '                page-break-inside: auto; \n';
                html += '                margin-bottom: 15px;\n';
                html += '            }\n';
                html += '            .section-header { \n';
                html += '                page-break-after: avoid;\n';
                html += '                font-size: 12pt;\n';
                html += '                padding: 8px;\n';
                html += '            }\n';
                html += '            .section-content { padding: 8px; }\n';
                html += '            \n';
                html += '            /* Optimisation de la grille */\n';
                html += '            .header-row { \n';
                html += '                grid-template-columns: 2.5fr 60px 60px 60px 60px; \n';
                html += '                font-size: 8pt;\n';
                html += '            }\n';
                html += '            .header-row.communication-header { \n';
                html += '                grid-template-columns: 2.5fr 60px 60px 60px 60px 60px; \n';
                html += '                padding: 5px 0;\n';
                html += '            }\n';
                html += '            .criteria-row { \n';
                html += '                grid-template-columns: 2.5fr 60px 60px 60px 60px; \n';
                html += '                page-break-inside: avoid;\n';
                html += '                padding: 8px 0 8px 5px;\n';
                html += '            }\n';
                html += '            .criteria-text { font-size: 8.5pt; line-height: 1.1 !important; }\n';
                html += '            .sub-criteria { font-size: 7.5pt; padding-left: 15px; line-height: 1.1 !important; }\n';
                html += '            .detail-row { font-size: 7.5pt; padding: 1px 0 1px 15px; line-height: 1.0; }\n';
                html += '            .detail-text { font-size: 7.5pt; line-height: 1.1 !important; }\n';
                html += '            .patient-response { font-size: 7.5pt; }\n';
                html += '            .points-display { font-size: 14px; }\n';
                html += '            \n';
                html += '            /* Communication section */\n';
                html += '            .communication-section-container {\n';
                html += '                page-break-inside: avoid !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Cloture section */\n';
                html += '            .cloture-section {\n';
                html += '                page-break-inside: avoid !important;\n';
                html += '            }\n';
                html += '            .cloture-item {\n';
                html += '                page-break-inside: avoid !important;\n';
                html += '                margin-bottom: 10px;\n';
                html += '                padding: 10px;\n';
                html += '            }\n';
                html += '            .cloture-title { font-size: 10pt; }\n';
                html += '            .cloture-content { font-size: 8.5pt; line-height: 1.2 !important; }\n';
                html += '            .communication-section { \n';
                html += '                grid-template-columns: 2.5fr 60px 60px 60px 60px 60px;\n';
                html += '                padding: 8px 0;\n';
                html += '            }\n';
                html += '            .communication-text { font-size: 8.5pt; }\n';
                html += '            .communication-desc { font-size: 7pt; }\n';
                html += '            \n';
                html += '            /* Optimisation des sections sp√©ciales */\n';
                html += '            .dd-section { padding: 8px; margin: 0 0 5px 0; font-size: 8pt; }\n';
                html += '            .dd-title { font-size: 9pt; }\n';
                html += '            .dd-item { font-size: 8pt; margin-left: 15px; }\n';
                html += '            \n';
                html += '            .therapy-section { \n';
                html += '                padding: 8px; \n';
                html += '                margin: 0; \n';
                html += '                font-size: 8pt;\n';
                html += '                background: rgba(255, 250, 230, 0.3) !important;\n';
                html += '                color: #000 !important;\n';
                html += '            }\n';
                html += '            .therapy-title { font-size: 9pt; }\n';
                html += '            \n';
                html += '            .redflags-section { padding: 8px; margin: 5px 0; }\n';
                html += '            .redflags-title { font-size: 9pt; }\n';
                html += '            .redflags-text { font-size: 8.5pt; }\n';
                html += '            .redflags-description { font-size: 7.5pt; }\n';
                html += '            \n';
                html += '            /* Optimisation des totaux */\n';
                html += '            .total-sections { \n';
                html += '                gap: 6px;\n';
                html += '                margin-bottom: 6px;\n';
                html += '            }\n';
                html += '            .total-label { \n';
                html += '                padding: 4px;\n';
                html += '                font-size: 16px;\n';
                html += '                border-radius: 8px 8px 0 0;\n';
                html += '            }\n';
                html += '            .total-body {\n';
                html += '                padding: 3px;\n';
                html += '                border-radius: 0 0 8px 8px;\n';
                html += '            }\n';
                html += '            .total-score,\n';
                html += '            .total-note-globale {\n';
                html += '                font-size: 32px;\n';
                html += '            }\n';
                html += '            .total-pourcent-body {\n';
                html += '                padding: 6px;\n';
                html += '                border-radius: 0 0 8px 8px;\n';
                html += '            }\n';
                html += '            .total-pourcent-sections {\n';
                html += '                display: flex;\n';
                html += '                flex-wrap: nowrap;\n';
                html += '                gap: 4px;\n';
                html += '                align-items: stretch;\n';
                html += '            }\n';
                html += '            .total-pourcent-section {\n';
                html += '                flex: 0 0 auto;\n';
                html += '                min-width: 60px;\n';
                html += '                padding: 6px 8px;\n';
                html += '                white-space: nowrap;\n';
                html += '            }\n';
                html += '            .total-section-label {\n';
                html += '                font-size: 11px;\n';
                html += '                margin-bottom: 3px;\n';
                html += '                white-space: nowrap;\n';
                html += '            }\n';
                html += '            .total-pourcent-value {\n';
                html += '                font-size: 20px;\n';
                html += '            }\n';
                html += '            .pourcent-body {\n';
                html += '                padding: 2px 0;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* √âchelle de notation */\n';
                html += '            .grade-scale { \n';
                html += '                padding: 10px; \n';
                html += '                margin-top: 15px;\n';
                html += '                page-break-inside: avoid;\n';
                html += '            }\n';
                html += '            .grade-scale h3 { font-size: 11pt; margin: 0 0 5px 0; }\n';
                html += '            .grade-row { padding: 3px 0; font-size: 8pt; }\n';
                html += '            \n';
                html += '            /* Optimisations pour les annexes √† l\'impression */\n';
                html += '            .annexes { \n';
                html += '                page-break-before: always !important;\n';
                html += '                margin-top: 0 !important;\n';
                html += '                padding-top: 15px !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .annexes-grid { \n';
                html += '                display: grid !important; \n';
                html += '                grid-template-columns: repeat(2, 1fr) !important; \n';
                html += '                gap: 15px !important; \n';
                html += '                margin-top: 15px !important; \n';
                html += '            }\n';
                html += '            \n';
                html += '            .annexe-item { \n';
                html += '                page-break-inside: avoid !important;\n';
                html += '                padding: 15px !important;\n';
                html += '                border: 1px solid #ddd !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .annexe-title { \n';
                html += '                font-size: 10pt !important;\n';
                html += '                margin-bottom: 5px !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .annexe-description { \n';
                html += '                font-size: 8pt !important;\n';
                html += '                line-height: 1.3 !important;\n';
                html += '                margin-bottom: 8px !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* R√©duire l\'interligne des detail-row */\n';
                html += '            .detail-row { \n';
                html += '                line-height: 1.1 !important; \n';
                html += '                padding: 2px 0 2px 15px !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* R√©duire et ajuster les checkboxes des d√©tails */\n';
                html += '            .detail-checkboxes { \n';
                html += '                text-align: right !important;\n';
                html += '                padding-right: 5px !important;\n';
                html += '            }\n';
                html += '            .detail-checkbox input[type="checkbox"] { \n';
                html += '                transform: scale(0.8) !important;\n';
                html += '                margin: 0 !important;\n';
                html += '            }\n';
                html += '            \n';
                // Pas de page-break pour le sc√©nario
                
                html += '            /* Page-break pour DD section et th√©orie pratique */\n';
                html += '            .annexe-dd-section,\n';
                html += '            .annexe-theorie-pratique { \n';
                html += '                page-break-before: always !important; \n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Pas de page-break dans les scenario-section */\n';
                html += '            .scenario-section, \n';
                html += '            .scenario-subsection { \n';
                html += '                page-break-inside: avoid !important; \n';
                html += '            }\n';
                html += '            \n';
                html += '            /* R√©duire l\'interligne dans toutes les annexes */\n';
                html += '            .annexe-scenario-content,\n';
                html += '            .annexe-interventions-content,\n';
                html += '            .annexe-informations-content,\n';
                html += '            .annexe-theorie-content { \n';
                html += '                line-height: 1.15 !important; \n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Styles sp√©cifiques pour les sections du sc√©nario */\n';
                html += '            .scenario-section {\n';
                html += '                margin-bottom: 8px !important;\n';
                html += '                padding: 4px !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .scenario-section h4 {\n';
                html += '                font-size: 9.5pt !important;\n';
                html += '                margin: 0 0 4px 0 !important;\n';
                html += '                line-height: 1.1 !important;\n';
                html += '                color: #2c5aa0 !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .scenario-subsection {\n';
                html += '                margin-bottom: 4px !important;\n';
                html += '                line-height: 1.1 !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .scenario-subsection strong {\n';
                html += '                font-size: 8pt !important;\n';
                html += '                color: #333 !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Listes dans les annexes */\n';
                html += '            .annexe-scenario-content ul,\n';
                html += '            .annexe-interventions-content ul,\n';
                html += '            .annexe-informations-content ul,\n';
                html += '            .annexe-theorie-content ul,\n';
                html += '            .scenario-section ul,\n';
                html += '            .scenario-subsection ul {\n';
                html += '                margin: 2px 0 !important;\n';
                html += '                padding-left: 16px !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            .annexe-scenario-content li,\n';
                html += '            .annexe-interventions-content li,\n';
                html += '            .annexe-informations-content li,\n';
                html += '            .annexe-theorie-content li,\n';
                html += '            .scenario-section li,\n';
                html += '            .scenario-subsection li {\n';
                html += '                margin-bottom: 1px !important;\n';
                html += '                line-height: 1.1 !important;\n';
                html += '                font-size: 7.5pt !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Texte dans les sections */\n';
                html += '            .scenario-section p,\n';
                html += '            .scenario-subsection p {\n';
                html += '                margin: 2px 0 !important;\n';
                html += '                line-height: 1.1 !important;\n';
                html += '                font-size: 7.5pt !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Info de base du patient */\n';
                html += '            .scenario-info {\n';
                html += '                font-size: 8pt !important;\n';
                html += '                padding: 6px !important;\n';
                html += '                margin-bottom: 8px !important;\n';
                html += '                line-height: 1.2 !important;\n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Forcer les couleurs */\n';
                html += '            * { \n';
                html += '                -webkit-print-color-adjust: exact !important; \n';
                html += '                print-color-adjust: exact !important; \n';
                html += '            }\n';
                html += '            \n';
                html += '            /* Fond blanc partout */\n';
                html += '            body, .container, .section, .section-content { background: white !important; }\n';
                html += '            \n';
                html += '        }\n';
                html += '    </style>\n';
                html += '</head>\n<body class="revision-mode">\n';
                
                // Corps du document
                html += '    <!-- MODE SELECTOR -->\n';
                html += '    <div class="mode-selector">\n';
                html += '        <button class="mode-button active" onclick="switchMode(\'revision\')">üîç R√©vision</button>\n';
                html += '        <button class="mode-button" onclick="switchMode(\'exam\')">üìù Examen</button>\n';
                html += '    </div>\n';
                html += '    \n';
                html += '    <!-- BOUTONS R√âVISION (Mode R√©vision uniquement) -->\n';
                html += '    <div class="revision-controls">\n';
                html += '        <button class="lacune-button" onclick="identifyLacunes()">üéØ Identifier les lacunes</button>\n';
                html += '        <button class="reset-revision-button" onclick="resetTimer()">‚Üª Reset</button>\n';
                html += '    </div>\n';
                html += '    \n';
                html += '    <!-- MINUTEUR ECOS -->\n';
                html += '    <div class="timer-container" id="timerContainer">\n';
                html += '        <div class="timer-display" id="timerDisplay">13:00</div>\n';
                html += '        <div class="timer-controls">\n';
                html += '            <button id="startBtn" class="timer-btn start-btn" onclick="startTimer()">‚ñ∂ D√©marrer</button>\n';
                html += '            <button id="stopBtn" class="timer-btn stop-btn" onclick="stopTimer()" style="display: none;">‚è∏ Arr√™ter</button>\n';
                html += '            <button id="resetBtn" class="timer-btn reset-btn" onclick="resetTimer()">‚Üª Reset</button>\n';
                html += '        </div>\n';
                html += '        <div class="timer-status" id="timerStatus" style="display: none;"></div>\n';
                html += '    </div>\n';
                html += '\n';
                html += '    <div class="container">\n';
                html += '        <div class="header">\n';
                html += '            <h1>Grille d\'√©valuation ECOS - ' + data.title + '</h1>\n';
                html += '            <p style="margin: 5px 0;">üìç ' + data.context.setting + '</p>\n';
                html += '            <p style="margin: 5px 0;">üë§ ' + data.context.patient + '</p>\n';

                // G√©n√©rer les signes vitaux
                const vitals = data.context.vitals || {};
                const labelMapping = {
                    'ta': 'TA',
                    'fc': 'FC', 
                    'fr': 'FR',
                    'temperature': 'T¬∞',
                    'saturation': 'SaO2',
                    'sao2': 'SaO2',
                    'imc': 'IMC',
                    'glycemie': 'Glyc√©mie',
                    'glasgow': 'Glasgow'
                };

                html += '            <div class="vital-signs">\n';
                Object.keys(vitals).forEach(key => {
                    const label = labelMapping[key] || key.toUpperCase();
                    const value = vitals[key];
                    html += '                <div class="vital-sign">\n';
                    html += '                    <div class="vital-sign-label">' + label + '</div>\n';
                    html += '                    <div class="vital-sign-value">' + value + '</div>\n';
                    html += '                </div>\n';
                });
                html += '            </div>\n';
                html += '        </div>\n';

                // D√©finir prefixMap globalement pour qu'il soit accessible partout
                const prefixMap = {
                    'presentation': 'p',
                    'raisonnement': 'r', 
                    'examens': 'e',
                    'management': 'm'
                };
                
                // G√©n√©ration des sections
                if (isNewFormat) {
                    // Format dynamique pour le nouveau format JSON
                    const sectionKeys = Object.keys(data.sections);
                    
                    sectionKeys.forEach((sectionKey, index) => {
                        const section = data.sections[sectionKey];
                        // Utiliser le titre personnalis√© de la section s'il existe, sinon utiliser le label par d√©faut
                        const sectionLabel = section.title || sectionLabels[sectionKey] || sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1);
                        const sectionId = sectionKey;
                        const prefix = prefixMap[sectionKey] || sectionKey.charAt(0);
                        const percentage = Math.round((section.weight || 0.25) * 100);
                        
                        html += '        <!-- ' + sectionLabel.toUpperCase() + ' -->\n';
                        html += '        <div class="section">\n';
                        html += '            <div class="section-header">\n';
                        html += '                <span>' + sectionLabel + ' (' + percentage + '%)</span>\n';
                        html += '                <span class="score">Score : <span id="' + sectionId + 'Score">0</span>/' + maxScores[sectionKey] + '</span>\n';
                        html += '            </div>\n';
                        html += '            <div class="section-content">\n';
                        html += '                <div class="header-row">\n';
                        html += '                    <div>Crit√®res</div>\n';
                        html += '                    <div>Oui</div>\n';
                        html += '                    <div>¬±</div>\n';
                        html += '                    <div>Non</div>\n';
                        html += '                    <div>Points</div>\n';
                        html += '                </div>\n';
                        html += generateCriteriaRows(section.criteria, prefix);
                        html += '                <div style="text-align: center; margin: 15px 0;">\n';
                        html += '                    <button class="section-comment-button" onclick="toggleSectionComment(\'' + sectionId + '\')" title="Commentaire sur cette section">üìù Commentaire sur la section ' + sectionLabel + '</button>\n';
                        html += '                </div>\n';
                        html += '                <div class="section-comment-section" id="section-comment-' + sectionId + '">\n';
                        html += '                    <h4 style="margin: 0 0 10px 0; color: #2c5aa0; font-size: 16px;">Commentaires sur ' + sectionLabel.toLowerCase() + '</h4>\n';
                        html += '                    <textarea class="comment-textarea" id="comment-section-' + sectionId + '" placeholder="Commentaire sur la section ' + sectionLabel.toLowerCase() + '..." oninput="updateSectionComment(\'' + sectionId + '\'); autoResizeTextarea(this);"></textarea>\n';
                        html += '                </div>\n';
                        html += '            </div>\n';
                        html += '        </div>\n';
                    });
                } else {
                    // Format traditionnel - Sections
                html += '        <!-- ANAMN√àSE -->\n';
                html += '        <div class="section">\n';
                html += '            <div class="section-header">\n';
                html += '                <span>Anamn√®se (25%)</span>\n';
                html += '                <span class="score">Score : <span id="anamneseScore">0</span>/' + maxScores.anamnese + '</span>\n';
                html += '            </div>\n';
                html += '            <div class="section-content">\n';
                html += '                <div class="header-row">\n';
                html += '                    <div>Crit√®res</div>\n';
                html += '                    <div>Oui</div>\n';
                html += '                    <div>¬±</div>\n';
                html += '                    <div>Non</div>\n';
                html += '                    <div>Points</div>\n';
                html += '                </div>\n';
                html += generateCriteriaRows(data.sections.anamnese.criteria, 'a');
                html += '                <div style="text-align: center; margin: 15px 0;">\n';
                html += '                    <button class="section-comment-button" onclick="toggleSectionComment(\'anamnese\')" title="Commentaire sur cette section">üìù Commentaire sur la section Anamn√®se</button>\n';
                html += '                </div>\n';
                html += '                <div class="section-comment-section" id="section-comment-anamnese">\n';
                html += '                    <h4 style="margin: 0 0 10px 0; color: #2c5aa0; font-size: 16px;">Commentaires sur l\'anamn√®se</h4>\n';
                html += '                    <textarea class="comment-textarea" id="comment-section-anamnese" placeholder="Commentaire sur la section anamn√®se..." oninput="updateSectionComment(\'anamnese\'); autoResizeTextarea(this);"></textarea>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '        </div>\n';

                html += '        <!-- EXAMEN CLINIQUE -->\n';
                html += '        <div class="section">\n';
                html += '            <div class="section-header">\n';
                html += '                <span>Examen clinique (25%)</span>\n';
                html += '                <span class="score">Score : <span id="statusScore">0</span>/' + maxScores.examen + '</span>\n';
                html += '            </div>\n';
                html += '            <div class="section-content">\n';
                html += '                <div class="header-row">\n';
                html += '                    <div>Crit√®res</div>\n';
                html += '                    <div>Oui</div>\n';
                html += '                    <div>¬±</div>\n';
                html += '                    <div>Non</div>\n';
                html += '                    <div>Points</div>\n';
                html += '                </div>\n';
                html += generateCriteriaRows(data.sections.examen.criteria, 'e');
                html += '                <div style="text-align: center; margin: 15px 0;">\n';
                html += '                    <button class="section-comment-button" onclick="toggleSectionComment(\'examen\')" title="Commentaire sur cette section">üìù Commentaire sur la section Examen</button>\n';
                html += '                </div>\n';
                html += '                <div class="section-comment-section" id="section-comment-examen">\n';
                html += '                    <h4 style="margin: 0 0 10px 0; color: #2c5aa0; font-size: 16px;">Commentaires sur l\'examen clinique</h4>\n';
                html += '                    <textarea class="comment-textarea" id="comment-section-examen" placeholder="Commentaire sur la section examen clinique..." oninput="updateSectionComment(\'examen\'); autoResizeTextarea(this);"></textarea>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '        </div>\n';

                html += '        <!-- MANAGEMENT -->\n';
                html += '        <div class="section">\n';
                html += '            <div class="section-header">\n';
                html += '                <span>Management (25%)</span>\n';
                html += '                <span class="score">Score : <span id="managementScore">0</span>/' + maxScores.management + '</span>\n';
                html += '            </div>\n';
                html += '            <div class="section-content">\n';
                html += '                <div class="header-row">\n';
                html += '                    <div>Crit√®res</div>\n';
                html += '                    <div>Oui</div>\n';
                html += '                    <div>¬±</div>\n';
                html += '                    <div>Non</div>\n';
                html += '                    <div>Points</div>\n';
                html += '                </div>\n';
                html += generateCriteriaRows(data.sections.management.criteria, 'm');
                html += '                <div style="text-align: center; margin: 15px 0;">\n';
                html += '                    <button class="section-comment-button" onclick="toggleSectionComment(\'management\')" title="Commentaire sur cette section">üìù Commentaire sur la section Management</button>\n';
                html += '                </div>\n';
                html += '                <div class="section-comment-section" id="section-comment-management">\n';
                html += '                    <h4 style="margin: 0 0 10px 0; color: #2c5aa0; font-size: 16px;">Commentaires sur le management</h4>\n';
                html += '                    <textarea class="comment-textarea" id="comment-section-management" placeholder="Commentaire sur la section management..." oninput="updateSectionComment(\'management\'); autoResizeTextarea(this);"></textarea>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '        </div>\n';

                // Section Cl√¥ture (si pr√©sente)
                if (data.sections.cloture && data.sections.cloture.criteria && data.sections.cloture.criteria.length > 0) {
                    html += '        <!-- CL√îTURE -->\n';
                    html += '        <div class="section cloture-section">\n';
                    html += '            <div class="section-header">\n';
                    html += '                <span>Cl√¥ture de consultation</span>\n';
                    html += '            </div>\n';
                    html += '            <div class="section-content">\n';
                    data.sections.cloture.criteria.forEach(criterion => {
                        // D√©terminer si le contenu est entre crochets
                        const isBracketed = criterion.content && criterion.content.startsWith('[') && criterion.content.endsWith(']');
                        const contentClass = isBracketed ? 'cloture-content' : 'cloture-content cloture-content-green';
                        
                        html += '                <div class="cloture-item">\n';
                        html += '                    <h4 class="cloture-title">' + criterion.text + '</h4>\n';
                        html += '                    <div class="' + contentClass + '">' + criterion.content + '</div>\n';
                        
                        // Ajouter les exemples de phrases si pr√©sents
                        if (criterion.exemplesPhrases && criterion.exemplesPhrases.length > 0) {
                            html += '                    <div class="exemples-phrases">\n';
                            criterion.exemplesPhrases.forEach(phrase => {
                                html += '                        <div class="exemple-phrase">"' + phrase + '"</div>\n';
                            });
                            html += '                    </div>\n';
                        }
                        
                        html += '                </div>\n';
                    });
                    html += '            </div>\n';
                    html += '        </div>\n';
                }

                // Section Communication
                html += '        <!-- COMMUNICATION -->\n';
                html += '        <div class="section communication-section-container">\n';
                html += '            <div class="section-header">\n';
                html += '                <span>Communication (25%)</span>\n';
                html += '                <span class="score">Score : <span id="communicationScore">0</span>/20</span>\n';
                html += '            </div>\n';
                html += '            <div class="section-content">\n';
                html += '                <div class="header-row communication-header">\n';
                html += '                    <div>Crit√®res</div>\n';
                html += '                    <div>A</div>\n';
                html += '                    <div>B</div>\n';
                html += '                    <div>C</div>\n';
                html += '                    <div>D</div>\n';
                html += '                    <div>E</div>\n';
                html += '                </div>\n';
                
                const commCriteria = [
                    { 
                        text: "R√©ponse aux sentiments et besoins du patient", 
                        desc: "Empathie, √©coute active, validation des √©motions<br />\nExplique le d√©roulement de la consultation et v√©rifie les pr√©occupations du patient, commence l'anamn√®se par une question ouverte ; reconna√Æt, verbalise et l√©gitime les √©motions, fournit du soutient" 
                    },
                    { 
                        text: "Structure de l'entretien", 
                        desc: "Organisation logique, transitions fluides, gestion du temps<br />\nSe pr√©sente par son nom et sa fonction, les √©tapes de l'entretien sont identifiables et s'encha√Ænent de mani√®re logique, gestion du temps, adaptation √† la situation" 
                    },
                    { 
                        text: "Expression verbale", 
                        desc: "Clart√©, vocabulaire adapt√©, v√©rification de la compr√©hension<br />\nLangage adapt√© au niveau du patient, pas de jargon, explications compr√©hensibles, reformulations quand n√©cessaire, r√©p√©titions des points cl√©s, fait une synth√®se de la consultation, bonne articulation, ton et volume ad√©quats" 
                    },
                    { 
                        text: "Expression non verbale", 
                        desc: "Contact visuel, posture, gestuelle appropri√©e<br />\nDistance interpersonnelle ad√©quate, posture ad√©quate, gestes ad√©quats, contact visuel et expression faciale ad√©quats, pauses quand n√©cessaire" 
                    },
                    { 
                        text: "√âvaluation g√©n√©rale de la communication", 
                        desc: "Qualit√© globale de l'interaction m√©decin-patient" 
                    }
                ];
                
                const criteriaNamesShort = [
                    "R√©ponse aux sentiments du patient",
                    "Structure de l'entretien", 
                    "Expression verbale",
                    "Expression non verbale",
                    "√âvaluation g√©n√©rale"
                ];
                
                commCriteria.forEach((crit, i) => {
                    const num = i + 1;
                    const id = 'c' + num;
                    html += '                <div class="communication-section" id="criteria-c' + num + '">\n';
                    html += '                    <div>\n';
                    html += '                        <div class="communication-text">' + num + '. ' + crit.text + ' <button class="comment-button" onclick="toggleComment(\'' + id + '\')" title="Ajouter un commentaire">üìù</button></div>\n';
                    // S√©parer la description en deux parties
                    const descParts = crit.desc.split('<br />\\n');
                    if (descParts.length > 1) {
                        html += '                        <div class="communication-desc">' + descParts[0] + '</div>\n';
                        html += '                        <div class="communication-desc-detail">' + descParts[1] + '</div>\n';
                    } else {
                        html += '                        <div class="communication-desc">' + crit.desc + '</div>\n';
                    }
                    html += '                        <div class="criterion-comment-section" id="comment-section-' + id + '">\n';
                    html += '                            <textarea class="comment-textarea" id="comment-' + id + '" placeholder="Commentaire sur ce crit√®re..." oninput="updateCommentButton(\'' + id + '\'); autoResizeTextarea(this);"></textarea>\n';
                    html += '                        </div>\n';
                    html += '                    </div>\n';
                    ['A', 'B', 'C', 'D', 'E'].forEach(grade => {
                        html += '                    <div class="checkbox-group">\n';
                        html += '                        <input type="radio" name="c' + num + '" value="' + grade + '" data-criteria="' + criteriaNamesShort[i] + '" onchange="updateScore(\'communication\', this)" />\n';
                        html += '                    </div>\n';
                    });
                    html += '                </div>\n';
                });
                
                html += '                <div style="text-align: center; margin: 15px 0;">\n';
                html += '                    <button class="section-comment-button" onclick="toggleSectionComment(\'communication\')" title="Commentaire sur cette section">üìù Commentaire sur la section Communication</button>\n';
                html += '                </div>\n';
                html += '                <div class="section-comment-section" id="section-comment-communication">\n';
                html += '                    <h4 style="margin: 0 0 10px 0; color: #2c5aa0; font-size: 16px;">Commentaires sur la communication</h4>\n';
                html += '                    <textarea class="comment-textarea" id="comment-section-communication" placeholder="Commentaire sur la section communication..." oninput="updateSectionComment(\'communication\'); autoResizeTextarea(this);"></textarea>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '        </div>\n';
                }
                
                // Totaux et √©chelle de notation
                html += '        <!-- TOTAUX -->\n';
                html += '        <div class="total-sections">\n';
                html += '            <div class="total-section">\n';
                html += '                <div class="total-label">Score Global</div>\n';
                html += '                <div class="total-body">\n';
                html += '                    <div class="total-score" id="totalScore">0/' + maxTotal + '</div>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '            <div class="total-section">\n';
                html += '                <div class="total-label">% par Section</div>\n';
                html += '                <div class="total-pourcent-body">\n';
                html += '                    <div class="total-pourcent-sections">\n';
                
                if (isNewFormat) {
                    // G√©n√©ration dynamique pour le nouveau format
                    Object.keys(data.sections).forEach(sectionKey => {
                        const section = data.sections[sectionKey];
                        // Utiliser le titre personnalis√© de la section s'il existe
                        const sectionLabel = section.title || sectionLabels[sectionKey] || sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1);
                        html += '                        <div class="total-pourcent-section">\n';
                        html += '                            <div class="total-section-label">' + sectionLabel + '</div>\n';
                        html += '                            <div class="pourcent-body">\n';
                        html += '                                <div class="total-pourcent-value"><span id="' + sectionKey + '-percentage">0</span>%</div>\n';
                        html += '                            </div>\n';
                        html += '                        </div>\n';
                    });
                } else {
                    // Format traditionnel
                    html += '                        <div class="total-pourcent-section">\n';
                    html += '                            <div class="total-section-label">Anamn√®se</div>\n';
                    html += '                            <div class="pourcent-body">\n';
                    html += '                                <div class="total-pourcent-value"><span id="anamnese-percentage">0</span>%</div>\n';
                    html += '                            </div>\n';
                    html += '                        </div>\n';
                    html += '                        <div class="total-pourcent-section">\n';
                    html += '                            <div class="total-section-label">Examen clinique</div>\n';
                    html += '                            <div class="pourcent-body">\n';
                    html += '                                <div class="total-pourcent-value"><span id="examen-percentage">0</span>%</div>\n';
                    html += '                            </div>\n';
                    html += '                        </div>\n';
                    html += '                        <div class="total-pourcent-section">\n';
                    html += '                            <div class="total-section-label">Management</div>\n';
                    html += '                            <div class="pourcent-body">\n';
                    html += '                                <div class="total-pourcent-value"><span id="management-percentage">0</span>%</div>\n';
                    html += '                            </div>\n';
                    html += '                        </div>\n';
                    html += '                        <div class="total-pourcent-section">\n';
                    html += '                            <div class="total-section-label">Communication</div>\n';
                    html += '                            <div class="pourcent-body">\n';
                    html += '                                <div class="total-pourcent-value"><span id="communication-percentage">0</span>%</div>\n';
                    html += '                            </div>\n';
                    html += '                        </div>\n';
                }
                
                html += '                    </div>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '            <div class="total-section">\n';
                html += '                <div class="total-label">Note Globale</div>\n';
                html += '                <div class="total-body">\n';
                html += '                    <div class="total-note-globale" id="globalGrade">E</div>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '        </div>\n';

                html += '        <!-- √âCHELLE DE NOTATION -->\n';
                html += '        <div class="grade-scale" style="padding: 10px 15px; background: #f8f9fa; border-radius: 8px;">\n';
                html += '            <h3 style="margin: 0 0 10px 0; font-size: 16px;">√âchelle de notation</h3>\n';
                html += '            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center;">\n';
                html += '                <div>\n';
                html += '                    <div style="font-weight: bold; font-size: 24px; color: #2c974b;">A</div>\n';
                html += '                    <div style="font-size: 12px; color: #666;">‚â•90%</div>\n';
                html += '                </div>\n';
                html += '                <div>\n';
                html += '                    <div style="font-weight: bold; font-size: 24px; color: #4e9cf0;">B</div>\n';
                html += '                    <div style="font-size: 12px; color: #666;">80-89%</div>\n';
                html += '                </div>\n';
                html += '                <div>\n';
                html += '                    <div style="font-weight: bold; font-size: 24px; color: #f0ad4e;">C</div>\n';
                html += '                    <div style="font-size: 12px; color: #666;">70-79%</div>\n';
                html += '                </div>\n';
                html += '                <div>\n';
                html += '                    <div style="font-weight: bold; font-size: 24px; color: #e67e22;">D</div>\n';
                html += '                    <div style="font-size: 12px; color: #666;">60-69%</div>\n';
                html += '                </div>\n';
                html += '                <div>\n';
                html += '                    <div style="font-weight: bold; font-size: 24px; color: #d9534f;">E</div>\n';
                html += '                    <div style="font-size: 12px; color: #666;">&lt;60%</div>\n';
                html += '                </div>\n';
                html += '            </div>\n';
                html += '        </div>\n';

                html += '        <!-- √âL√âMENTS MANQUANTS (MASQU√âS) -->\n';
                html += '        <!-- <div class="missing-items" id="missingItems" style="display: none;">\n';
                html += '            <h3>√âl√©ments non √©valu√©s</h3>\n';
                html += '            <div id="missingList"></div>\n';
                html += '        </div> -->\n';

                // Annexes et red flags
                html += generateAnnexes(data.annexes);
                html += generateRedFlagsSection(data.redflagsSection);

                // Section de commentaire g√©n√©ral
                html += '        <!-- COMMENTAIRE G√âN√âRAL -->\n';
                html += '        <div class="section-comment-section global">\n';
                html += '            <h4 style="margin: 0 0 10px 0; color: #2c5aa0; font-size: 18px;">Commentaire g√©n√©ral</h4>\n';
                html += '            <textarea class="comment-textarea" id="comment-general" placeholder="Commentaire g√©n√©ral sur l\'√©valuation..." oninput="updateGeneralComment(); autoResizeTextarea(this);"></textarea>\n';
                html += '        </div>\n';

                html += '    </div>\n';

                // Script JavaScript pour la grille g√©n√©r√©e
                html += '    <script>\n';
                html += '        // D√©claration des variables globales\n';
                html += '        window.audioContext = null;\n';
                html += '        \n';
                html += '        function updateScore(section, element) {\n';
                html += '            const value = element.value;\n';
                html += '            const name = element.name;\n';
                html += '            let pointValue;\n\n';
                html += '            if (section === "communication") {\n';
                html += '                const map = { A: 4, B: 3, C: 2, D: 1, E: 0 };\n';
                html += '                pointValue = map[value] || 0;\n';
                html += '                // Mettre √† jour la classe de couleur pour communication\n';
                html += '                const criteriaRow = document.getElementById("criteria-" + name);\n';
                html += '                if (criteriaRow) {\n';
                html += '                    criteriaRow.classList.remove("score-a", "score-b", "score-c", "score-d", "score-e", "lacune-rouge", "lacune-orange", "lacune-verte");\n';
                html += '                    criteriaRow.classList.add("score-" + value.toLowerCase());\n';
                html += '                    // Ajouter les classes lacune pour communication\n';
                html += '                    if (value === "E" || value === "D") {\n';
                html += '                        criteriaRow.classList.add("lacune-rouge");\n';
                html += '                    } else if (value === "C") {\n';
                html += '                        criteriaRow.classList.add("lacune-orange");\n';
                html += '                    } else if (value === "A" || value === "B") {\n';
                html += '                        criteriaRow.classList.add("lacune-verte");\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            } else {\n';
                html += '                pointValue = Number(value) || 0;\n';
                html += '                // Mettre √† jour la classe de couleur pour autres crit√®res\n';
                html += '                const criteriaRow = document.getElementById("criteria-" + name);\n';
                html += '                if (criteriaRow) {\n';
                html += '                    criteriaRow.classList.remove("score-0", "score-1", "score-2", "lacune-rouge", "lacune-orange", "lacune-verte");\n';
                html += '                    criteriaRow.classList.add("score-" + value);\n';
                html += '                    // Ajouter les classes lacune pour crit√®res normaux\n';
                html += '                    if (pointValue === 0) {\n';
                html += '                        criteriaRow.classList.add("lacune-rouge");\n';
                html += '                    } else if (pointValue === 1) {\n';
                html += '                        criteriaRow.classList.add("lacune-orange");\n';
                html += '                    } else if (pointValue >= 2) {\n';
                html += '                        criteriaRow.classList.add("lacune-verte");\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            }\n\n';
                html += '            const pointsElement = document.getElementById("points-" + name);\n';
                html += '            if (pointsElement) {\n';
                html += '                pointsElement.textContent = pointValue;\n';
                html += '            }\n\n';
                html += '            calculateScores();\n';
                html += '        }\n\n';
                
                html += '        function updateDetailScore(criterionId, prefix) {\n';
                html += '            let totalScore = 0;\n';
                html += '            const detailCheckboxes = document.querySelectorAll(\'input[id^="\' + criterionId + \'-detail-"]\');\n';
                html += '            const maxDetailsScore = detailCheckboxes.length;\n';
                html += '            \n';
                html += '            detailCheckboxes.forEach(checkbox => {\n';
                html += '                if (checkbox.checked) {\n';
                html += '                    totalScore += Number(checkbox.value) || 0;\n';
                html += '                }\n';
                html += '            });\n';
                html += '            \n';
                html += '            const pointsElement = document.getElementById("points-" + criterionId);\n';
                html += '            if (pointsElement) {\n';
                html += '                pointsElement.textContent = totalScore;\n';
                html += '            }\n';
                html += '            \n';
                html += '            // Mettre √† jour la classe de couleur en fonction du score et du max\n';
                html += '            const criteriaRow = document.getElementById("criteria-" + criterionId);\n';
                html += '            if (criteriaRow) {\n';
                html += '                criteriaRow.classList.remove("score-0", "score-1", "score-2", "score-3", "score-4", "score-5", "score-max", "lacune-rouge", "lacune-orange", "lacune-verte");\n';
                html += '                \n';
                html += '                // D√©terminer la classe appropri√©e avec les seuils 1/3 et 2/3\n';
                html += '                const oneThird = maxDetailsScore / 3;\n';
                html += '                const twoThirds = (maxDetailsScore * 2) / 3;\n';
                html += '                \n';
                html += '                if (totalScore < oneThird) {\n';
                html += '                    criteriaRow.classList.add("score-0");\n';
                html += '                    criteriaRow.classList.add("lacune-rouge");\n';
                html += '                } else if (totalScore > twoThirds) {\n';
                html += '                    criteriaRow.classList.add("score-max");\n';
                html += '                    criteriaRow.classList.add("lacune-verte");\n';
                html += '                } else {\n';
                html += '                    // Score entre 1/3 et 2/3\n';
                html += '                    criteriaRow.classList.add("score-1");\n';
                html += '                    criteriaRow.classList.add("lacune-orange");\n';
                html += '                }\n';
                html += '            }\n';
                html += '            \n';
                html += '            calculateScores();\n';
                html += '        }\n\n';
                
                html += '        function calculateScores() {\n';
                html += '            const isNewFormat = ' + (isNewFormat ? 'true' : 'false') + ';\n';
                html += '            const missingItems = [];\n';
                html += '            let scores = {};\n';
                html += '            let maxScores = {};\n';
                html += '            let coef = {};\n';
                html += '            let sectionInfo = [];\n\n';
                
                if (isNewFormat) {
                    // Pour le nouveau format
                    html += '            // Configuration pour le nouveau format\n';
                    Object.keys(data.sections).forEach(sectionKey => {
                        const section = data.sections[sectionKey];
                        const prefix = prefixMap[sectionKey] || sectionKey.charAt(0);
                        // Utiliser le titre personnalis√© de la section s'il existe
                        const label = section.title || sectionLabels[sectionKey] || sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1);
                        html += '            scores["' + sectionKey + '"] = 0;\n';
                        html += '            maxScores["' + sectionKey + '"] = ' + maxScores[sectionKey] + ';\n';
                        html += '            coef["' + sectionKey + '"] = ' + (section.weight || 0.25) + ';\n';
                        html += '            sectionInfo.push({key: "' + sectionKey + '", prefix: "' + prefix + '", count: ' + section.criteria.length + ', label: "' + label + '"});\n';
                    });
                } else {
                    // Pour le format traditionnel
                    html += '            // Configuration pour le format traditionnel\n';
                    html += '            scores = {anamnese: 0, examen: 0, management: 0, communication: 0};\n';
                    html += '            maxScores = {anamnese: ' + maxScores.anamnese + ', examen: ' + maxScores.examen + ', management: ' + maxScores.management + ', communication: 20};\n';
                    html += '            coef = {anamnese: 0.25, examen: 0.25, management: 0.25, communication: 0.25};\n';
                    html += '            sectionInfo = [\n';
                    html += '                {key: "anamnese", prefix: "a", count: ' + data.sections.anamnese.criteria.length + ', label: "Anamn√®se"},\n';
                    html += '                {key: "examen", prefix: "e", count: ' + data.sections.examen.criteria.length + ', label: "Examen clinique", scoreId: "statusScore"},\n';
                    html += '                {key: "management", prefix: "m", count: ' + data.sections.management.criteria.length + ', label: "Management"},\n';
                    html += '                {key: "communication", prefix: "c", count: 5, label: "Communication", isComm: true}\n';
                    html += '            ];\n';
                }
                html += '\n';
                
                // Calcul dynamique des scores par section
                html += '            // Calcul des scores pour chaque section\n';
                html += '            sectionInfo.forEach(section => {\n';
                html += '                let sectionScore = 0;\n';
                html += '                \n';
                html += '                if (section.isComm) {\n';
                html += '                    // Section communication sp√©ciale\n';
                html += '                    for (let i = 1; i <= section.count; i++) {\n';
                html += '                        const radio = document.querySelector("input[name=\\"" + section.prefix + i + "\\"]:checked");\n';
                html += '                        if (radio) {\n';
                html += '                            const val = radio.value;\n';
                html += '                            const map = { A: 4, B: 3, C: 2, D: 1, E: 0 };\n';
                html += '                            sectionScore += map[val] || 0;\n';
                html += '                        } else {\n';
                html += '                            const criteria = document.querySelector("input[name=\\"" + section.prefix + i + "\\"][data-criteria]");\n';
                html += '                            if (criteria) missingItems.push(section.label + " : " + criteria.dataset.criteria);\n';
                html += '                        }\n';
                html += '                    }\n';
                html += '                } else {\n';
                html += '                    // Sections normales\n';
                html += '                    for (let i = 1; i <= section.count; i++) {\n';
                html += '                        const criterionId = section.prefix + i;\n';
                html += '                        // V√©rifier si ce crit√®re a des d√©tails avec checkboxes\n';
                html += '                        const detailCheckboxes = document.querySelectorAll(\'input[id^="\' + criterionId + \'-detail-"]\');\n';
                html += '                        \n';
                html += '                        if (detailCheckboxes.length > 0) {\n';
                html += '                            // Ce crit√®re a des d√©tails, on calcule le score bas√© sur les d√©tails\n';
                html += '                            let detailScore = 0;\n';
                html += '                            let hasCheckedDetail = false;\n';
                html += '                            detailCheckboxes.forEach(checkbox => {\n';
                html += '                                if (checkbox.checked) {\n';
                html += '                                    detailScore += Number(checkbox.value) || 0;\n';
                html += '                                    hasCheckedDetail = true;\n';
                html += '                                }\n';
                html += '                            });\n';
                html += '                            sectionScore += detailScore;\n';
                html += '                            \n';
                html += '                            if (!hasCheckedDetail) {\n';
                html += '                                const criteria = document.querySelector("input[name=\\"" + criterionId + "\\"][data-criteria]");\n';
                html += '                                if (criteria) {\n';
                html += '                                    missingItems.push(section.label + " : " + criteria.dataset.criteria);\n';
                html += '                                } else {\n';
                html += '                                    // Rechercher le texte du crit√®re directement\n';
                html += '                                    const criteriaText = document.querySelector("#criteria-" + criterionId + " .criteria-text");\n';
                html += '                                    if (criteriaText) {\n';
                html += '                                        missingItems.push(section.label + " : " + criteriaText.textContent.split(". ")[1].split(" [")[0]);\n';
                html += '                                    }\n';
                html += '                                }\n';
                html += '                            }\n';
                html += '                        } else {\n';
                html += '                            // Crit√®re normal sans d√©tails\n';
                html += '                            const radio = document.querySelector("input[name=\\"" + criterionId + "\\"]:checked");\n';
                html += '                            if (radio) {\n';
                html += '                                sectionScore += Number(radio.value) || 0;\n';
                html += '                            } else {\n';
                html += '                                const criteria = document.querySelector("input[name=\\"" + criterionId + "\\"][data-criteria]");\n';
                html += '                                if (criteria) missingItems.push(section.label + " : " + criteria.dataset.criteria);\n';
                html += '                            }\n';
                html += '                        }\n';
                html += '                    }\n';
                html += '                }\n';
                html += '                \n';
                html += '                scores[section.key] = sectionScore;\n';
                html += '                const scoreId = section.scoreId || section.key + "Score";\n';
                html += '                const scoreElement = document.getElementById(scoreId);\n';
                html += '                if (scoreElement) scoreElement.textContent = sectionScore;\n';
                html += '            });\n';
                html += '\n';
                html += '            // Calcul des pourcentages par section\n';
                html += '            let percentages = {};\n';
                html += '            let globalPercentage = 0;\n';
                html += '            let isStarted = false;\n';
                html += '            \n';
                html += '            sectionInfo.forEach(section => {\n';
                html += '                const score = scores[section.key];\n';
                html += '                const max = maxScores[section.key];\n';
                html += '                const percentage = max > 0 ? (score / max) * 100 : 0;\n';
                html += '                percentages[section.key] = percentage;\n';
                html += '                globalPercentage += percentage * coef[section.key];\n';
                html += '                if (score > 0) isStarted = true;\n';
                html += '            });\n';
                html += '\n';
                
                html += '            const totalScoreText = isStarted ? Math.round(globalPercentage) : 0;\n';
                html += '            document.getElementById("totalScore").textContent = totalScoreText + "%";\n\n';
                
                html += '            // Mise √† jour des pourcentages affich√©s\n';
                html += '            sectionInfo.forEach(section => {\n';
                html += '                const percentageElement = document.getElementById(section.key + "-percentage");\n';
                html += '                if (percentageElement) {\n';
                html += '                    percentageElement.textContent = Math.round(percentages[section.key]);\n';
                html += '                }\n';
                html += '            });\n\n';
                
                html += '            const gradeElement = document.getElementById("globalGrade");\n';
                html += '            const totalScoreElement = document.getElementById("totalScore");\n';
                html += '            const scoreBody = totalScoreElement ? totalScoreElement.closest(".total-body") : null;\n';
                html += '            const gradeBody = gradeElement ? gradeElement.closest(".total-body") : null;\n';
                html += '            const sections = sectionInfo.map(s => s.key);\n\n';
                
                html += '            const allClasses = ["note-a", "note-b", "note-c", "note-d", "note-e", "note-neutral"];\n\n';
                
                html += '            function getClass(p) {\n';
                html += '                if (p === 0) return "note-neutral";\n';
                html += '                if (p >= 90) return "note-a";\n';
                html += '                if (p >= 80) return "note-b";\n';
                html += '                if (p >= 70) return "note-c";\n';
                html += '                if (p >= 60) return "note-d";\n';
                html += '                return "note-e";\n';
                html += '            }\n\n';
                
                html += '            const gradeClass = getClass(globalPercentage);\n';
                html += '            const gradeLabel = isStarted ? gradeClass.split("-")[1].toUpperCase() : "A-E";\n';
                html += '            if (gradeElement) gradeElement.textContent = gradeLabel;\n\n';
                
                html += '            const pourcentBody = document.querySelector(".total-pourcent-body");\n\n';
                
                html += '            [gradeElement, scoreBody, gradeBody, pourcentBody].forEach(el => {\n';                html += '                if (el) {\n';
                html += '                    el.classList.remove(...allClasses);\n';
                html += '                    el.classList.add(gradeClass);\n';                html += '                }\n';
                html += '            });\n\n';
                
                html += '            sections.forEach(id => {\n';
                html += '                const percentageElement = document.getElementById(id + "-percentage");\n';
                html += '                if (percentageElement) {\n';
                html += '                    const value = parseInt(percentageElement.textContent);\n';
                html += '                    const section = percentageElement.closest(".total-pourcent-section");\n';
                html += '                    const sectionClass = getClass(value);\n';
                html += '                    if (section) {\n';
                html += '                        section.classList.remove(...allClasses);\n';
                html += '                        section.classList.add(sectionClass);\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            });\n\n';
                
                html += '            // Appliquer les couleurs aux sections principales\n';
                html += '            sectionInfo.forEach(section => {\n';
                html += '                const percentage = percentages[section.key];\n';
                html += '                const allSections = document.querySelectorAll(".section");\n';
                html += '                allSections.forEach(sectionEl => {\n';
                html += '                    const headerText = sectionEl.querySelector(".section-header")?.textContent || "";\n';
                html += '                    if (headerText.includes(section.label)) {\n';
                html += '                        const sectionClass = getClass(percentage);\n';
                html += '                        sectionEl.classList.remove(...allClasses);\n';
                html += '                        sectionEl.classList.add(sectionClass);\n';
                html += '                    }\n';
                html += '                });\n';
                html += '            });\n\n';
                
                html += '            if (missingItems.length > 0) {\n';
                html += '                document.getElementById("missingItems").style.display = "block";\n';
                html += '                document.getElementById("missingList").innerHTML = missingItems.map(item =>\n';
                html += '                    "<div class=\\"missing-item\\">‚Ä¢ " + item + "</div>"\n';
                html += '                ).join("");\n';
                html += '            } else {\n';
                html += '                document.getElementById("missingItems").style.display = "none";\n';
                html += '            }\n';
                html += '        }\n';
                
                html += '        // MINUTEUR ECOS 13 MINUTES\n';
                html += '        window.timerInterval = null;\n';
                html += '        window.currentSeconds = 13 * 60;\n';
                html += '        window.isRunning = false;\n';
                html += '        window.hasStarted = false;\n';
                html += '        window.hasFinished = false;\n';
                html += '        window.hasStoppedManually = false;\n';
                html += '\n';
                html += '        window.currentMode = \'revision\';\n';
                html += '\n';
                html += '        function colorPatientResponses() {\n';
                html += '            // Version simplifi√©e inspir√©e du g√©n√©rateur v1\n';
                html += '            const elements = document.querySelectorAll(\'.criteria-text, .sub-criteria, .redflags-text, .dd-item, .therapy-section, .detail-text, .cloture-content\');\n';
                html += '            elements.forEach(element => {\n';
                html += '                const text = element.innerHTML;\n';
                html += '                // Colorer uniquement les r√©ponses patient en bleu (pas les examens compl√©mentaires)\n';
                html += '                let coloredText = text.replace(/\\[([^\\]]+)\\]/g, \'<span style="color: rgb(44, 90, 160); font-weight: 500;">[$1]</span>\');\n';
                html += '                element.innerHTML = coloredText;\n';
                html += '            });\n';
                html += '        }\n';
                html += '\n';
                html += '        document.addEventListener(\'DOMContentLoaded\', function() {\n';
                html += '            switchMode(\'revision\');\n';
                html += '            calculateScores();\n';
                html += '            colorPatientResponses();\n';
                html += '            // Appeler une deuxi√®me fois apr√®s un court d√©lai pour s\'assurer que tout est charg√©\n';
                html += '            setTimeout(function() {\n';
                html += '                colorPatientResponses();\n';
                html += '            }, 100);\n';
                html += '            // Appel suppl√©mentaire apr√®s un d√©lai plus long pour garantir que tout est charg√©\n';
                html += '            setTimeout(function() {\n';
                html += '                colorPatientResponses();\n';
                html += '            }, 500);\n';
                html += '            // Auto-resize tous les textareas au chargement\n';
                html += '            const allTextareas = document.querySelectorAll(\'.comment-textarea\');\n';
                html += '            allTextareas.forEach(textarea => {\n';
                html += '                if (textarea.value) {\n';
                html += '                    autoResizeTextarea(textarea);\n';
                html += '                }\n';
                html += '            });\n';
                html += '        });\n';
                html += '        \n';
                html += '        // S\'assurer que la hauteur est bien d√©finie avant l\'impression\n';
                html += '        window.addEventListener(\'beforeprint\', function() {\n';
                html += '            const allTextareas = document.querySelectorAll(\'.comment-textarea\');\n';
                html += '            allTextareas.forEach(textarea => {\n';
                html += '                if (textarea.value && textarea.value.trim()) {\n';
                html += '                    // S\'assurer que le textarea a une hauteur d√©finie\n';
                html += '                    if (!textarea.style.height || textarea.style.height === \'auto\') {\n';
                html += '                        autoResizeTextarea(textarea);\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            });\n';
                html += '        });\n';
                html += '\n';
                html += '\n';
                html += '        function initAudio() {\n';
                html += '            if (!window.audioContext) {\n';
                html += '                window.audioContext = new (window.AudioContext || window.webkitAudioContext)();\n';
                html += '            }\n';
                html += '        }\n';
                html += '\n';
                html += '        function playBeep() {\n';
                html += '            initAudio();\n';
                html += '            const oscillator = window.audioContext.createOscillator();\n';
                html += '            const gainNode = window.audioContext.createGain();\n';
                html += '            oscillator.connect(gainNode);\n';
                html += '            gainNode.connect(window.audioContext.destination);\n';
                html += '            oscillator.frequency.value = 800;\n';
                html += '            oscillator.type = \'sine\';\n';
                html += '            gainNode.gain.setValueAtTime(0.3, window.audioContext.currentTime);\n';
                html += '            gainNode.gain.exponentialRampToValueAtTime(0.01, window.audioContext.currentTime + 0.5);\n';
                html += '            oscillator.start(window.audioContext.currentTime);\n';
                html += '            oscillator.stop(window.audioContext.currentTime + 0.5);\n';
                html += '        }\n';
                html += '\n';
                html += '        function speak(text) {\n';
                html += '            if (\'speechSynthesis\' in window) {\n';
                html += '                const utterance = new SpeechSynthesisUtterance(text);\n';
                html += '                utterance.lang = \'fr-FR\';\n';
                html += '                utterance.rate = 0.9;\n';
                html += '                utterance.volume = 0.8;\n';
                html += '                speechSynthesis.speak(utterance);\n';
                html += '            }\n';
                html += '        }\n';
                html += '\n';
                html += '        function playSound(message) {\n';
                html += '            playBeep();\n';
                html += '            setTimeout(() => speak(message), 500);\n';
                html += '        }\n';
                html += '\n';
                html += '        function formatTime(seconds) {\n';
                html += '            const minutes = Math.floor(seconds / 60);\n';
                html += '            const secs = seconds % 60;\n';
                html += '            return minutes + ":" + secs.toString().padStart(2, "0");\n';
                html += '        }\n';
                html += '\n';
                html += '        function toggleCheckboxes(disabled) {\n';
                html += '            const radios = document.querySelectorAll(\'input[type="radio"]\');\n';
                html += '            radios.forEach(radio => {\n';
                html += '                radio.disabled = disabled;\n';
                html += '            });\n';
                html += '            const detailCheckboxes = document.querySelectorAll(\'.detail-checkbox input[type="checkbox"]\');\n';
                html += '            detailCheckboxes.forEach(checkbox => {\n';
                html += '                checkbox.disabled = disabled;\n';
                html += '            });\n';
                html += '        }\n';
                html += '\n';
                html += '        function colorCriteriaByScore() {\n';
                html += '            if (!window.hasFinished && !window.hasStoppedManually) return;\n';
                html += '\n';
                html += '            const normalCriteriaRows = document.querySelectorAll(\'.criteria-row\');\n';
                html += '            normalCriteriaRows.forEach(row => {\n';
                html += '                const id = row.id;\n';
                html += '                if (!id) return;\n';
                html += '                const criteriaName = id.replace(\'criteria-\', \'\');\n';
                html += '                const checkedRadio = document.querySelector(\'input[name="\' + criteriaName + \'"]:checked\');\n';
                html += '                row.classList.remove(\'criteria-zero-points\', \'criteria-one-point\', \'criteria-full-points\', \'criteria-not-answered\', \'lacune-rouge\', \'lacune-orange\', \'lacune-verte\');\n';
                html += '                if (checkedRadio) {\n';
                html += '                    const score = Number(checkedRadio.value) || 0;\n';
                html += '                    if (score === 0) {\n';
                html += '                        row.classList.add(\'criteria-zero-points\');\n';
                html += '                        row.classList.add(\'lacune-rouge\');\n';
                html += '                    } else if (score === 1) {\n';
                html += '                        row.classList.add(\'criteria-one-point\');\n';
                html += '                        row.classList.add(\'lacune-orange\');\n';
                html += '                    } else if (score >= 2) {\n';
                html += '                        row.classList.add(\'criteria-full-points\');\n';
                html += '                        row.classList.add(\'lacune-verte\');\n';
                html += '                    }\n';
                html += '                } else {\n';
                html += '                    row.classList.add(\'criteria-not-answered\');\n';
                html += '                    row.classList.add(\'lacune-rouge\');\n';
                html += '                }\n';
                html += '            });\n';
                html += '\n';
                html += '            const communicationRows = document.querySelectorAll(\'.communication-section\');\n';
                html += '            communicationRows.forEach(row => {\n';
                html += '                const id = row.id;\n';
                html += '                if (!id) return;\n';
                html += '                const criteriaName = id.replace(\'criteria-\', \'\');\n';
                html += '                const checkedRadio = document.querySelector(\'input[name="\' + criteriaName + \'"]:checked\');\n';
                html += '                row.classList.remove(\'communication-note-a\', \'communication-note-b\', \'communication-note-c\', \'communication-note-d\', \'communication-note-e\', \'communication-not-answered\', \'lacune-rouge\', \'lacune-orange\', \'lacune-verte\');\n';
                html += '                if (checkedRadio) {\n';
                html += '                    const grade = checkedRadio.value.toLowerCase();\n';
                html += '                    row.classList.add("communication-note-" + grade);\n';
                html += '                    if (grade === \'e\' || grade === \'d\') {\n';
                html += '                        row.classList.add(\'lacune-rouge\');\n';
                html += '                    } else if (grade === \'c\') {\n';
                html += '                        row.classList.add(\'lacune-orange\');\n';
                html += '                    } else if (grade === \'a\' || grade === \'b\') {\n';
                html += '                        row.classList.add(\'lacune-verte\');\n';
                html += '                    }\n';
                html += '                } else {\n';
                html += '                    row.classList.add(\'communication-not-answered\');\n';
                html += '                    row.classList.add(\'lacune-rouge\');\n';
                html += '                }\n';
                html += '            });\n';
                html += '        }\n';
                html += '\n';
                html += '        function startTimer() {\n';
                html += '            if (window.isRunning || window.currentMode !== \'exam\') return;\n';
                html += '            window.isRunning = true;\n';
                html += '            window.hasStarted = true;\n';
                html += '            window.hasStoppedManually = false;\n';
                html += '            document.body.classList.add(\'timer-running\');\n';
                html += '            toggleCheckboxes(false);\n';
                html += '            playSound("D√©but de la station");\n';
                html += '            document.getElementById(\'startBtn\').style.display = \'none\';\n';
                html += '            document.getElementById(\'stopBtn\').style.display = \'inline-block\';\n';
                html += '            document.getElementById(\'resetBtn\').disabled = true;\n';
                html += '            document.getElementById(\'timerStatus\').textContent = \'En cours\';\n';
                html += '            document.getElementById(\'timerStatus\').className = \'timer-status status-running\';\n';
                html += '            \n';
                html += '            window.timerInterval = setInterval(() => {\n';
                html += '                window.currentSeconds--;\n';
                html += '                document.getElementById(\'timerDisplay\').textContent = formatTime(window.currentSeconds);\n';
                html += '                const container = document.getElementById(\'timerContainer\');\n';
                html += '                if (window.currentSeconds === 2 * 60) {\n';
                html += '                    if (window.currentMode === \'exam\') {\n';
                html += '                        playSound("Il vous reste 2 minutes");\n';
                html += '                    }\n';
                html += '                    container.classList.add(\'timer-warning\');\n';
                html += '                    document.getElementById(\'timerStatus\').textContent = \'2 min restantes\';\n';
                html += '                    document.getElementById(\'timerStatus\').className = \'timer-status status-warning\';\n';
                html += '                }\n';
                html += '                if (window.currentSeconds <= 30) {\n';
                html += '                    container.classList.add(\'timer-critical\');\n';
                html += '                }\n';
                html += '                if (window.currentSeconds <= 0) {\n';
                html += '                    endTimer();\n';
                html += '                }\n';
                html += '            }, 1000);\n';
                html += '        }\n';
                html += '\n';
                html += '        function stopTimer() {\n';
                html += '            if (!window.isRunning) return;\n';
                html += '            clearInterval(window.timerInterval);\n';
                html += '            window.isRunning = false;\n';
                html += '            window.hasStoppedManually = true;\n';
                html += '            document.body.classList.remove(\'timer-running\');\n';
                html += '            // Ne pas d√©sactiver les checkboxes pour permettre de continuer √† cocher apr√®s arr√™t\n';
                html += '            // toggleCheckboxes(true);\n';
                html += '            document.getElementById(\'startBtn\').style.display = \'inline-block\';\n';
                html += '            document.getElementById(\'stopBtn\').style.display = \'none\';\n';
                html += '            document.getElementById(\'resetBtn\').disabled = false;\n';
                html += '            document.getElementById(\'timerStatus\').textContent = \'Arr√™t√©\';\n';
                html += '            document.getElementById(\'timerStatus\').className = \'timer-status\';\n';
                html += '            colorCriteriaByScore();\n';
                html += '        }\n';
                html += '\n';
                html += '        function endTimer() {\n';
                html += '            clearInterval(window.timerInterval);\n';
                html += '            window.isRunning = false;\n';
                html += '            window.hasFinished = true;\n';
                html += '            window.currentSeconds = 0;\n';
                html += '            document.body.classList.remove(\'timer-running\');\n';
                html += '            if (window.currentMode === \'exam\') {\n';
                html += '                playSound("Fin de la station. Veuillez sortir");\n';
                html += '                // Repasser automatiquement en mode r√©vision apr√®s la fin du timer\n';
                html += '                switchMode(\'revision\');\n';
                html += '            }\n';
                html += '            document.getElementById(\'timerDisplay\').textContent = \'0:00\';\n';
                html += '            document.getElementById(\'startBtn\').style.display = \'inline-block\';\n';
                html += '            document.getElementById(\'stopBtn\').style.display = \'none\';\n';
                html += '            document.getElementById(\'resetBtn\').disabled = false;\n';
                html += '            document.getElementById(\'timerStatus\').textContent = \'Termin√©\';\n';
                html += '            document.getElementById(\'timerStatus\').className = \'timer-status status-finished\';\n';
                html += '            document.getElementById(\'timerStatus\').style.display = \'block\';\n';
                html += '            document.getElementById(\'timerContainer\').className = \'timer-container\';\n';
                html += '            // Ne pas d√©sactiver les checkboxes apr√®s la fin pour permettre de continuer\n';
                html += '            // toggleCheckboxes(true);\n';
                html += '            colorCriteriaByScore();\n';
                html += '        }\n';
                html += '\n';
                html += '        function resetTimer() {\n';
                html += '            clearInterval(window.timerInterval);\n';
                html += '            window.timerInterval = null;\n';
                html += '            window.currentSeconds = 13 * 60;\n';
                html += '            window.isRunning = false;\n';
                html += '            window.hasStarted = false;\n';
                html += '            window.hasFinished = false;\n';
                html += '            window.hasStoppedManually = false;\n';
                html += '            document.getElementById(\'timerDisplay\').textContent = \'13:00\';\n';
                html += '            document.getElementById(\'startBtn\').style.display = \'inline-block\';\n';
                html += '            document.getElementById(\'stopBtn\').style.display = \'none\';\n';
                html += '            // Supprimer la coloration des crit√®res\n';
                html += '            const criteriaAndCommRows = document.querySelectorAll(\'.criteria-row, .communication-section\');\n';
                html += '            criteriaAndCommRows.forEach(row => {\n';
                html += '                row.classList.remove(\'score-0\', \'score-1\', \'score-2\', \'score-a\', \'score-b\', \'score-c\', \'score-d\', \'score-e\');\n';
                html += '            });\n';
                html += '            // Supprimer la coloration des sections\n';
                html += '            const allSections = document.querySelectorAll(\'.section\');\n';
                html += '            allSections.forEach(section => {\n';
                html += '                section.classList.remove(\'note-a\', \'note-b\', \'note-c\', \'note-d\', \'note-e\');\n';
                html += '                section.classList.add(\'note-neutral\');\n';
                html += '            });\n';
                html += '            document.getElementById(\'timerStatus\').style.display = \'none\';\n';
                html += '            document.getElementById(\'timerContainer\').className = \'timer-container\';\n';
                html += '            // En mode r√©vision, ne pas d√©sactiver les checkboxes\n';
                html += '            if (window.currentMode === \'exam\') {\n';
                html += '                toggleCheckboxes(true);\n';
                html += '            }\n';
                html += '            const allRadios = document.querySelectorAll(\'input[type="radio"]\');\n';
                html += '            allRadios.forEach(radio => {\n';
                html += '                radio.checked = false;\n';
                html += '            });\n';
                html += '            // R√©initialiser les detail-checkboxes\n';
                html += '            const allDetailCheckboxes = document.querySelectorAll(\'.detail-checkbox input[type="checkbox"]\');\n';
                html += '            allDetailCheckboxes.forEach(checkbox => {\n';
                html += '                checkbox.checked = false;\n';
                html += '            });\n';
                html += '            const allPointsDisplays = document.querySelectorAll(\'.points-display\');\n';
                html += '            allPointsDisplays.forEach(display => {\n';
                html += '                display.textContent = \'0\';\n';
                html += '            });\n';
                html += '            const allCriteriaRows = document.querySelectorAll(\'.criteria-row\');\n';
                html += '            allCriteriaRows.forEach(row => {\n';
                html += '                row.classList.remove(\'criteria-zero-points\', \'criteria-one-point\', \'criteria-full-points\', \'criteria-not-answered\', \'lacune-rouge\', \'lacune-orange\', \'lacune-verte\');\n';
                html += '            });\n';
                html += '            const allCommunicationRows = document.querySelectorAll(\'.communication-section\');\n';
                html += '            allCommunicationRows.forEach(row => {\n';
                html += '                row.classList.remove(\'communication-note-a\', \'communication-note-b\', \'communication-note-c\', \'communication-note-d\', \'communication-note-e\', \'communication-not-answered\', \'lacune-rouge\', \'lacune-orange\', \'lacune-verte\');\n';
                html += '            });\n';
                html += '            calculateScores();\n';
                html += '            // Supprimer tous les commentaires et cacher les textareas\n';
                html += '            const allTextareas = document.querySelectorAll(\'.comment-textarea\');\n';
                html += '            allTextareas.forEach(textarea => {\n';
                html += '                textarea.value = \'\';\n';
                html += '                textarea.style.height = textarea.classList.contains(\'comment-textarea\') && textarea.closest(\'.section-comment-section.global\') ? \'30px\' : (textarea.closest(\'.section-comment-section\') ? \'28px\' : \'26px\');\n';
                html += '            });\n';
                html += '            // Cacher toutes les sections de commentaires ouvertes\n';
                html += '            const allCommentSections = document.querySelectorAll(\'.criterion-comment-section.show, .section-comment-section.show\');\n';
                html += '            allCommentSections.forEach(section => {\n';
                html += '                section.classList.remove(\'show\');\n';
                html += '            });\n';
                html += '            // Mettre √† jour les boutons de commentaires\n';
                html += '            const allCommentButtons = document.querySelectorAll(\'.comment-button, .section-comment-button\');\n';
                html += '            allCommentButtons.forEach(button => {\n';
                html += '                button.classList.remove(\'has-content\');\n';
                html += '            });\n';
                html += '        }\n';
                html += '        \n';
                html += '        function switchMode(mode) {\n';
                html += '            window.currentMode = mode;\n';
                html += '            const body = document.body;\n';
                html += '            body.className = mode + \'-mode\';\n';
                html += '            const buttons = document.querySelectorAll(\'.mode-button\');\n';
                html += '            buttons.forEach(btn => btn.classList.remove(\'active\'));\n';
                html += '            buttons.forEach(btn => {\n';
                html += '                if (btn.textContent.includes(mode === "revision" ? "R√©vision" : "Examen")) {\n';
                html += '                    btn.classList.add("active");\n';
                html += '                }\n';
                html += '            });\n';
                html += '            if (mode === \'revision\') {\n';
                html += '                toggleCheckboxes(false);\n';
                html += '                showLacunesButton();\n';
                html += '            } else {\n';
                html += '                if (!window.hasStarted) {\n';
                html += '                    toggleCheckboxes(true);\n';
                html += '                }\n';
                html += '                hideLacunesButton();\n';
                html += '            }\n';
                html += '        }\n';
                html += '        \n';
                html += '        function showLacunesButton() {\n';
                html += '            const btn = document.querySelector(\'.lacune-button\');\n';
                html += '            if (btn) btn.style.display = \'block\';\n';
                html += '        }\n';
                html += '        \n';
                html += '        function hideLacunesButton() {\n';
                html += '            const btn = document.querySelector(\'.lacune-button\');\n';
                html += '            if (btn) btn.style.display = \'none\';\n';
                html += '        }\n';
                html += '        \n';
                html += '        function identifyLacunes() {\n';
                html += '            // Crit√®res standards (anamn√®se, examen, management)\n';
                html += '            const criteria = document.querySelectorAll(".criteria-row");\n';
                html += '            criteria.forEach(criterion => {\n';
                html += '                const id = criterion.id.replace("criteria-", "");\n';
                html += '                const pointsElement = document.getElementById("points-" + id);\n';
                html += '                const points = pointsElement ? parseInt(pointsElement.textContent) : 0;\n';
                html += '                \n';
                html += '                criterion.classList.remove("lacune-rouge", "lacune-orange", "lacune-verte");\n';
                html += '                \n';
                html += '                if (points === 0) {\n';
                html += '                    criterion.classList.add("lacune-rouge");\n';
                html += '                } else if (points === 1) {\n';
                html += '                    criterion.classList.add("lacune-orange");\n';
                html += '                } else if (points >= 2) {\n';
                html += '                    criterion.classList.add("lacune-verte");\n';
                html += '                }\n';
                html += '            });\n';
                html += '            \n';
                html += '            // Crit√®res communication (√©chelle A-E)\n';
                html += '            const commCriteria = document.querySelectorAll(".communication-section");\n';
                html += '            commCriteria.forEach(criterion => {\n';
                html += '                const id = criterion.id.replace("criteria-", "");\n';
                html += '                const radio = document.querySelector("input[name=\\"" + id + "\\"]:checked");\n';
                html += '                \n';
                html += '                criterion.classList.remove("lacune-rouge", "lacune-orange", "lacune-verte");\n';
                html += '                \n';
                html += '                if (!radio) {\n';
                html += '                    criterion.classList.add("lacune-rouge");\n';
                html += '                } else {\n';
                html += '                    const grade = radio.value;\n';
                html += '                    if (grade === "E" || grade === "D") {\n';
                html += '                        criterion.classList.add("lacune-rouge");\n';
                html += '                    } else if (grade === "C") {\n';
                html += '                        criterion.classList.add("lacune-orange");\n';
                html += '                    } else if (grade === "A" || grade === "B") {\n';
                html += '                        criterion.classList.add("lacune-verte");\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            });\n';
                html += '        }\n';
                
                // Fonctions pour les commentaires
                html += '        function toggleComment(id) {\n';
                html += '            const section = document.getElementById("comment-section-" + id);\n';
                html += '            const textarea = document.getElementById("comment-" + id);\n';
                html += '            if (section) {\n';
                html += '                section.classList.toggle("show");\n';
                html += '                // Focus automatiquement sur le textarea quand on ouvre la section\n';
                html += '                if (section.classList.contains("show") && textarea) {\n';
                html += '                    textarea.focus();\n';
                html += '                }\n';
                html += '            }\n';
                html += '        }\n\n';
                
                html += '        function updateCommentButton(id) {\n';
                html += '            const textarea = document.getElementById("comment-" + id);\n';
                html += '            const criterionRow = document.getElementById("criteria-" + id);\n';
                html += '            const commentSection = document.getElementById("comment-section-" + id);\n';
                html += '            if (textarea && criterionRow) {\n';
                html += '                const button = criterionRow.querySelector(".comment-button");\n';
                html += '                if (button) {\n';
                html += '                    if (textarea.value.trim()) {\n';
                html += '                        button.classList.add("has-content");\n';
                html += '                        if (commentSection) commentSection.classList.add("has-content");\n';
                html += '                    } else {\n';
                html += '                        button.classList.remove("has-content");\n';
                html += '                        if (commentSection) commentSection.classList.remove("has-content");\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            }\n';
                html += '        }\n\n';
                
                html += '        function toggleSectionComment(section) {\n';
                html += '            const commentSection = document.getElementById("section-comment-" + section);\n';
                html += '            const textarea = document.getElementById("comment-section-" + section);\n';
                html += '            if (commentSection) {\n';
                html += '                commentSection.classList.toggle("show");\n';
                html += '                // Focus automatiquement sur le textarea quand on ouvre la section\n';
                html += '                if (commentSection.classList.contains("show") && textarea) {\n';
                html += '                    textarea.focus();\n';
                html += '                }\n';
                html += '            }\n';
                html += '        }\n\n';
                
                html += '        function updateSectionComment(section) {\n';
                html += '            const textarea = document.getElementById("comment-section-" + section);\n';
                html += '            const commentSection = document.getElementById("section-comment-" + section);\n';
                html += '            const buttons = document.querySelectorAll(".section-comment-button");\n';
                html += '            buttons.forEach(button => {\n';
                html += '                if (button.getAttribute("onclick") && button.getAttribute("onclick").includes(section)) {\n';
                html += '                    if (textarea && textarea.value.trim()) {\n';
                html += '                        button.classList.add("has-content");\n';
                html += '                        if (commentSection) commentSection.classList.add("has-content");\n';
                html += '                    } else {\n';
                html += '                        button.classList.remove("has-content");\n';
                html += '                        if (commentSection) commentSection.classList.remove("has-content");\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            });\n';
                html += '        }\n\n';
                
                html += '        function updateGeneralComment() {\n';
                html += '            const textarea = document.getElementById("comment-general");\n';
                html += '            if (textarea) {\n';
                html += '                const section = textarea.closest(".section-comment-section");\n';
                html += '                if (section) {\n';
                html += '                    if (textarea.value.trim()) {\n';
                html += '                        section.classList.add("has-content");\n';
                html += '                    } else {\n';
                html += '                        section.classList.remove("has-content");\n';
                html += '                    }\n';
                html += '                }\n';
                html += '            }\n';
                html += '        }\n\n';
                
                html += '        function autoResizeTextarea(textarea) {\n';
                html += '            // Reset height to auto to get correct scrollHeight\n';
                html += '            textarea.style.height = "auto";\n';
                html += '            // Set new height based on content\n';
                html += '            const newHeight = textarea.scrollHeight + 2;\n';
                html += '            textarea.style.height = newHeight + "px";\n';
                html += '        }\n\n';
                
                // Les fonctions pour les modes et lacunes sont d√©j√† d√©finies plus haut
                
                html += '    <' + '/script>\n';
                
                // Ajout du bouton PDF
                html += '    <!-- BOUTON IMPRIMER EN PDF -->\n';
                html += '    <button class="print-button" onclick="window.print()">üñ®Ô∏è Imprimer en PDF</button>\n';
                
                html += '    <script>\n';
                html += '        // Appel final pour s\'assurer que tout est color√©\n';
                html += '        // Forcer la coloration finale\n';
                html += '        if (window.colorPatientResponses) {\n';
                html += '            window.colorPatientResponses();\n';
                html += '        }\n';
                html += '    <\/script>\n';
                
                html += '</body>\n</html>';

                generatedHTML = html;

                // Afficher l'aper√ßu
                const preview = document.getElementById('previewFrame');
                preview.srcdoc = generatedHTML;
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('downloadBtn').style.display = 'inline-block';
                document.getElementById('printBtn').style.display = 'inline-block';

                showSuccess('Grille ECOS g√©n√©r√©e avec succ√®s !');

            } catch (error) {
                showError('Erreur dans le JSON : ' + error.message);
                console.error('Erreur compl√®te:', error);
            }
        }

        function downloadHTML() {
            if (!generatedHTML) {
                showError('Aucune grille g√©n√©r√©e');
                return;
            }

            // Utiliser le titre original avec " - Grille ECOS" √† la fin
            const filename = currentData && currentData.title ? 
                `${currentData.title} - Grille ECOS.html` : 
                'grille_ecos.html';

            const blob = new Blob([generatedHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printECOS() {
            if (!generatedHTML) {
                showError('Aucune grille g√©n√©r√©e');
                return;
            }

            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank');
            printWindow.document.write(generatedHTML);
            printWindow.document.close();
            
            // D√©finir le nom du fichier sugg√©r√© pour l'impression/PDF
            const titre = currentData && currentData.title ? currentData.title : 'Grille ECOS';
            printWindow.document.title = titre + ' - Grille ECOS';
            
            // Attendre que le contenu soit charg√© puis imprimer
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // Initialisation quand le DOM est charg√©
        document.addEventListener('DOMContentLoaded', function() {
            // Gestionnaire pour le chargement de fichier
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.getElementById('jsonInput').value = event.target.result;
                            showSuccess('Fichier JSON charg√© avec succ√®s. Cliquez sur "G√©n√©rer la grille ECOS" pour continuer.');
                        };
                        reader.onerror = function() {
                            showError('Erreur lors de la lecture du fichier.');
                        };
                        reader.readAsText(file);
                    }
                });
            }

            // Gestionnaire pour le bouton de g√©n√©ration
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateECOS);
            }

            // Gestionnaire pour le bouton de t√©l√©chargement
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadHTML);
            }

            // Gestionnaire pour le bouton d'impression
            const printBtn = document.getElementById('printBtn');
            if (printBtn) {
                printBtn.addEventListener('click', printECOS);
            }
        });
    

// Ajouter les labels V5 pour la nouvelle structure standardis√©e
const LABELS_V5 = {
    // Labels des sections principales
    scenarioPatienteStandardisee: 'Sc√©nario pour le patient standardis√©',
    informationsExpert: 'Informations pour l\'expert',
    theoriePratique: 'Th√©orie et pratique',
    
    // Labels des sous-sections de scenarioPatienteStandardisee
    motifConsultation: 'Motif de consultation',
    plaintePrincipale: 'Plainte principale',
    autreChose: 'Autre chose √† ajouter',
    
    // Anamn√®se actuelle
    anamn√®seActuelle: 'Anamn√®se actuelle',
    histoireActuelle: 'Histoire actuelle',
    douleurActuelle: 'Douleur actuelle',
    symptomePrincipal: 'Sympt√¥me principal',
    symptomesPrincipaux: 'Sympt√¥mes principaux',
    debutSymptomes: 'D√©but des sympt√¥mes',
    evolutionTemporelle: '√âvolution temporelle',
    
    // Caract√©risation de la plainte
    caracterisationPlainte: 'Caract√©risation de la plainte',
    quantificationDouleur: 'Quantification de la douleur',
    douleurCaracteristiques: 'Caract√©ristiques de la douleur',
    localisation: 'Localisation',
    intensite: 'Intensit√©',
    qualite: 'Qualit√©',
    irradiation: 'Irradiation',
    
    // Signes de gravit√©
    signesGravite: 'Signes de gravit√©',
    redflag: 'Drapeaux rouges',
    urgence: 'Signes d\'urgence',
    
    // Sympt√¥mes associ√©s
    symptomesAssocies: 'Sympt√¥mes associ√©s',
    generale: 'Sympt√¥mes g√©n√©raux',
    neurologique: 'Sympt√¥mes neurologiques',
    cardiovasculaire: 'Sympt√¥mes cardiovasculaires',
    respiratoire: 'Sympt√¥mes respiratoires',
    digestif: 'Sympt√¥mes digestifs',
    urinaire: 'Sympt√¥mes urinaires',
    gynecologique: 'Sympt√¥mes gyn√©cologiques',
    
    // Anamn√®se syst√©mique
    anamn√®seSystemique: 'Anamn√®se syst√©mique',
    
    // Facteurs de risque
    facteursRisques: 'Facteurs de risque',
    facteursModulants: 'Facteurs modulants',
    aggravation: 'Facteurs d\'aggravation',
    amelioration: 'Facteurs d\'am√©lioration',
    comorbidites: 'Comorbidit√©s',
    expositions: 'Expositions',
    
    // Contexte m√©dical
    contexteMedical: 'Contexte m√©dical',
    maladies: 'Maladies actuelles',
    allergies: 'Allergies',
    medicaments: 'M√©dicaments',
    traitements: 'Traitements',
    contraception: 'Contraception',
    grossesse: 'Grossesse',
    
    // Ant√©c√©dents m√©dicaux
    antecedentsMedicaux: 'Ant√©c√©dents m√©dicaux',
    ATCDmedicaux: 'Ant√©c√©dents m√©dicaux',
    ATCDchirurgicaux: 'Ant√©c√©dents chirurgicaux',
    ATCDobstetricaux: 'Ant√©c√©dents obst√©tricaux',
    statusVaccinal: 'Statut vaccinal',
    priseEnCharge: 'Ant√©c√©dents de prise en charge',
    
    // Ant√©c√©dents familiaux
    antecedentsFamiliaux: 'Ant√©c√©dents familiaux',
    pere: 'P√®re',
    mere: 'M√®re',
    fratrie: 'Fratrie',
    
    // Habitudes
    habitudes: 'Habitudes de vie',
    tabac: 'Tabac',
    UPA: 'UPA (paquets-ann√©es)',
    alcool: 'Alcool',
    stupefiants: 'Stup√©fiants',
    alimentation: 'Alimentation',
    sexuels: 'Habitudes sexuelles',
    activitePhysique: 'Activit√© physique',
    
    // Contexte psychosocial
    contextePsychoSocial: 'Contexte psychosocial',
    profession: 'Profession',
    habitation: 'Habitation',
    autonomie: 'Autonomie',
    entourage: 'Entourage',
    stress: 'Stress',
    
    // Simulation
    simulation: 'Instructions de simulation',
    attitude: 'Attitude g√©n√©rale',
    durantEntretien: 'Durant l\'entretien',
    durantExamen: 'Durant l\'examen',
    
    // Inqui√©tudes
    inquietudes: 'Inqui√©tudes du patient',
    principales: 'Inqui√©tudes principales',
    questions: 'Questions du patient',
    
    // Labels pour informationsExpert
    pointsCles: 'Points cl√©s',
    pieges: 'Pi√®ges √† √©viter',
    rolesInterventions: 'R√¥les et interventions',
    
    // Labels pour theoriePratique
    sections: 'Sections th√©oriques',
    rappelsTherapeutiques: 'Rappels th√©rapeutiques',
    examensComplementaires: 'Examens compl√©mentaires',
    
    // Labels pour autres sections d'annexes
    protocoleMedical: 'Protocole m√©dical',
    protocoleUrgence: 'Protocole d\'urgence',
    guideCommunication: 'Guide de communication',
    signesAlerte: 'Signes d\'alerte',
    ddSection: 'Diagnostics diff√©rentiels',
    defi: 'D√©fi'
};

// Fonction pour obtenir le label v5
function getLabelV5(key) {
    if (LABELS_V5[key]) {
        return LABELS_V5[key];
    }
    
    // Sinon, formater le camelCase en texte lisible
    return key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim();
}

// Fonction pour coloriser les r√©ponses patient
function colorizePatientResponses(text) {
    if (!text) return '';
    // Coloriser le texte entre crochets en bleu
    return text.replace(/\[([^\]]+)\]/g, '<span style="color: rgb(44, 90, 160);">[$1]</span>');
}


    
// =================== FONCTIONS V6 POUR STRUCTURE V3 ===================

// Labels V6 pour la structure v3
const LABELS_V6 = {
    // Sections principales
    informationsExpert: 'Informations pour l\'expert',
    scenarioPatienteStandardisee: 'Sc√©nario pour le patient standardis√©',
    theoriePratique: 'Th√©orie et pratique',
    
    // Sous-sections informationsExpert
    dossierMedical: 'Dossier m√©dical',
    rolesInterventions: 'R√¥les et interventions',
    questionsExpert: 'Questions de l\'expert',
    pointsCles: 'Points cl√©s',
    pieges: 'Pi√®ges √† √©viter',
    defisSpecifiques: 'D√©fis sp√©cifiques',
    objectifsPedagogiques: 'Objectifs p√©dagogiques',
    objectifsApprentissage: 'Objectifs d\'apprentissage',
    objectifsCommunication: 'Objectifs de communication',
    diagnosticDifferentiel: 'Diagnostic diff√©rentiel',
    urgencesMedicales: 'Urgences m√©dicales',
    urgencesObstetricales: 'Urgences obst√©tricales',
    signesAlarme: 'Signes d\'alarme',
    symptomesAlarme: 'Sympt√¥mes d\'alarme',
    facteursRisques: 'Facteurs de risque',
    techniquesGestion: 'Techniques de gestion',
    techniquesEvaluation: 'Techniques d\'√©valuation',
    priseEnCharge: 'Prise en charge',
    bonnesPratiques: 'Bonnes pratiques',
    agentCaustique: 'Agent caustique',
    resultatsLaboratoire: 'R√©sultats de laboratoire',
    
    // Sous-sections scenarioPatienteStandardisee
    identitePatient: 'Identit√© du patient',
    contexte: 'Contexte',
    motifConsultation: 'Motif de consultation',
    plaintePrincipale: 'Plainte principale',
    autreChose: 'Autre chose √† ajouter',
    consignes: 'Consignes',
    anamn√®seActuelle: 'Anamn√®se actuelle',
    histoireMaladie: 'Histoire de la maladie',
    caracteristiquesSymptomePrincipal: 'Caract√©ristiques du sympt√¥me principal',
    facteursModulateurs: 'Facteurs modulateurs',
    traitementsTentes: 'Traitements tent√©s',
    symptomesAssocies: 'Sympt√¥mes associ√©s',
    anamn√®seSystemique: 'Anamn√®se syst√©mique',
    antecedentsMedicaux: 'Ant√©c√©dents m√©dicaux',
    maladiesChroniques: 'Maladies chroniques',
    hospitalisations: 'Hospitalisations',
    chirurgies: 'Chirurgies',
    traumatismes: 'Traumatismes',
    allergies: 'Allergies',
    vaccinations: 'Vaccinations',
    medicamentsActuels: 'M√©dicaments actuels',
    antecedentsGynecologiques: 'Ant√©c√©dents gyn√©cologiques',
    antecedentsFamiliaux: 'Ant√©c√©dents familiaux',
    habitudesVie: 'Habitudes de vie',
    contextePsychoSocial: 'Contexte psychosocial',
    simulationJeuRole: 'Simulation et jeu de r√¥le',
    comportementPatient: 'Comportement du patient',
    reponsesPrevues: 'R√©ponses pr√©vues',
    defis: 'D√©fis',
    elementsNonVerbaux: '√âl√©ments non verbaux',
    signesAlarme: 'Signes d\'alarme',
    informationsComplementaires: 'Informations compl√©mentaires',
    
    // D√©tails identit√© patient
    nom: 'Nom',
    age: '√Çge',
    sexe: 'Sexe',
    origine: 'Origine',
    profession: 'Profession',
    etatCivil: '√âtat civil',
    enfants: 'Enfants',
    
    // D√©tails sympt√¥mes associ√©s
    generaux: 'Sympt√¥mes g√©n√©raux',
    neurologiques: 'Sympt√¥mes neurologiques',
    cardiovasculaires: 'Sympt√¥mes cardiovasculaires',
    respiratoires: 'Sympt√¥mes respiratoires',
    digestifs: 'Sympt√¥mes digestifs',
    urinaires: 'Sympt√¥mes urinaires',
    gynecologiques: 'Sympt√¥mes gyn√©cologiques',
    musculosquelettiques: 'Sympt√¥mes musculosquelettiques',
    dermatologiques: 'Sympt√¥mes dermatologiques',
    psychiatriques: 'Sympt√¥mes psychiatriques',
    ORL: 'Sympt√¥mes ORL',
    
    // D√©tails habitudes de vie
    tabac: 'Tabac',
    alcool: 'Alcool',
    stupefiants: 'Stup√©fiants',
    activitePhysique: 'Activit√© physique',
    alimentation: 'Alimentation',
    sommeil: 'Sommeil',
    sexualite: 'Sexualit√©',
    
    // D√©tails contexte psychosocial
    habitat: 'Habitat',
    famille: 'Famille',
    economique: 'Situation √©conomique',
    social: 'Contexte social',
    autonomie: 'Autonomie',
    culturel: 'Contexte culturel',
    
    // Sous-sections theoriePratique
    sections: 'Sections th√©oriques',
    rappelsTherapeutiques: 'Rappels th√©rapeutiques',
    examensComplementaires: 'Examens compl√©mentaires',
    diagnosticDifferentiel: 'Diagnostic diff√©rentiel',
    priseEnCharge: 'Prise en charge',
    protocolesSpecifiques: 'Protocoles sp√©cifiques',
    guidePratique: 'Guide pratique',
    ressources: 'Ressources',
    
    // Labels g√©n√©riques
    chroniques: 'Chroniques',
    ponctuels: 'Ponctuels',
    supplements: 'Suppl√©ments',
    observance: 'Observance',
    effetsSecondaires: 'Effets secondaires',
    automedication: 'Autom√©dication',
    
    // R√©sultats laboratoire
    fsc: 'Formule sanguine compl√®te',
    chimieSanguine: 'Chimie sanguine',
    analyseUrines: 'Analyse d\'urines',
    testGrossesse: 'Test de grossesse',
    
    // Autres
    attitude: 'Attitude',
    cooperation: 'Coop√©ration',
    emotions: '√âmotions',
    defense: 'M√©canismes de d√©fense',
    questions: 'Questions',
    examens: 'Examens',
    situations: 'Situations',
    communication: 'Communication',
    comportement: 'Comportement',
    cliniques: '√âl√©ments cliniques',
    details: 'D√©tails',
    cage: 'CAGE',
    relation: 'Relation',
    partenaires: 'Partenaires',
    protection: 'Protection',
    problemes: 'Probl√®mes',
    orientation: 'Orientation',
    statut: 'Statut',
    actuelle: 'Actuelle',
    type: 'Type',
    support: 'Support',
    activites: 'Activit√©s',
    isolement: 'Isolement',
    situation: 'Situation'
};

// Fonction principale pour g√©n√©rer les annexes v3
function generateAnnexesV3(annexes) {
    if (!annexes) return '';
    
    let html = '<div class="annexes">\n<h3>Annexes</h3>\n<div class="annexes-grid">\n';
    
    // 1. Informations pour l'expert
    if (annexes.informationsExpert) {
        html += generateInformationsExpertV3(annexes.informationsExpert);
    }
    
    // 2. Sc√©nario pour le patient standardis√©
    if (annexes.scenarioPatienteStandardisee) {
        html += generateScenarioPatientV3(annexes.scenarioPatienteStandardisee);
    }
    
    // 3. Th√©orie et pratique
    if (annexes.theoriePratique) {
        html += generateTheoriePratiqueV3(annexes.theoriePratique);
    }
    
    html += '</div>\n</div>\n';
    return html;
}

// Fonction pour g√©n√©rer informationsExpert
function generateInformationsExpertV3(infos) {
    let html = '<div class="annexe-item annexe-expert">\n';
    html += '    <div class="annexe-title">' + getLabelV6('informationsExpert') + '</div>\n';
    html += '    <div class="annexe-content">\n';
    
    // Titre et dossier m√©dical
    if (infos.titre) {
        html += '        <h4>' + infos.titre + '</h4>\n';
    }
    if (infos.dossierMedical) {
        html += '        <div class="info-section">\n';
        html += '            <strong>' + getLabelV6('dossierMedical') + ' :</strong> ' + colorizePatientResponses(infos.dossierMedical) + '\n';
        html += '        </div>\n';
    }
    
    // Arrays simples
    const simpleArrays = [
        'rolesInterventions', 'questionsExpert', 'pointsCles', 'pieges',
        'defisSpecifiques', 'objectifsPedagogiques', 'objectifsApprentissage',
        'objectifsCommunication', 'diagnosticDifferentiel', 'urgencesMedicales',
        'urgencesObstetricales', 'signesAlarme', 'symptomesAlarme', 'facteursRisques',
        'techniquesGestion', 'techniquesEvaluation', 'priseEnCharge', 'bonnesPratiques',
        'agentCaustique'
    ];
    
    simpleArrays.forEach(key => {
        if (infos[key] && Array.isArray(infos[key]) && infos[key].length > 0) {
            html += '        <div class="info-section">\n';
            html += '            <h4>' + getLabelV6(key) + '</h4>\n';
            html += '            <ul>\n';
            infos[key].forEach(item => {
                html += '                <li>' + colorizePatientResponses(item) + '</li>\n';
            });
            html += '            </ul>\n';
            html += '        </div>\n';
        }
    });
    
    // R√©sultats de laboratoire
    if (infos.resultatsLaboratoire) {
        html += generateResultatsLaboratoireV3(infos.resultatsLaboratoire);
    }
    
    html += '    </div>\n';
    html += '</div>\n';
    return html;
}

// Fonction pour g√©n√©rer scenarioPatienteStandardisee
function generateScenarioPatientV3(scenario) {
    let html = '<div class="annexe-item annexe-scenario">\n';
    html += '    <div class="annexe-title">' + getLabelV6('scenarioPatienteStandardisee') + '</div>\n';
    html += '    <div class="annexe-scenario-content">\n';
    
    // Titre
    if (scenario.titre) {
        html += '        <h4>' + scenario.titre + '</h4>\n';
    }
    
    // Identit√© du patient
    if (scenario.identitePatient) {
        html += generateIdentitePatientV3(scenario.identitePatient);
    }
    
    // Contexte
    if (scenario.contexte) {
        html += '        <div class="scenario-section">\n';
        html += '            <strong>' + getLabelV6('contexte') + ' :</strong> ' + colorizePatientResponses(scenario.contexte) + '\n';
        html += '        </div>\n';
    }
    
    // Motif de consultation
    if (scenario.motifConsultation) {
        html += generateMotifConsultationV3(scenario.motifConsultation);
    }
    
    // Consignes
    if (scenario.consignes && scenario.consignes.length > 0) {
        html += '        <div class="scenario-section">\n';
        html += '            <h4>' + getLabelV6('consignes') + '</h4>\n';
        html += '            <ul>\n';
        scenario.consignes.forEach(item => {
            html += '                <li>' + colorizePatientResponses(item) + '</li>\n';
        });
        html += '            </ul>\n';
        html += '        </div>\n';
    }
    
    // Anamn√®se actuelle
    if (scenario.anamn√®seActuelle) {
        html += generateAnamneseActuelleV3(scenario.anamn√®seActuelle);
    }
    
    // Sympt√¥mes associ√©s
    if (scenario.symptomesAssocies) {
        html += generateSymptomesAssociesV3(scenario.symptomesAssocies);
    }
    
    // Anamn√®se syst√©mique
    if (scenario.anamn√®seSystemique) {
        html += generateSectionObjetV3(scenario.anamn√®seSystemique, 'anamn√®seSystemique');
    }
    
    // Ant√©c√©dents m√©dicaux
    if (scenario.antecedentsMedicaux) {
        html += generateAntecedentsMedicauxV3(scenario.antecedentsMedicaux);
    }
    
    // M√©dicaments actuels
    if (scenario.medicamentsActuels) {
        html += generateMedicamentsActuelsV3(scenario.medicamentsActuels);
    }
    
    // Ant√©c√©dents gyn√©cologiques
    if (scenario.antecedentsGynecologiques) {
        html += generateSectionObjetV3(scenario.antecedentsGynecologiques, 'antecedentsGynecologiques');
    }
    
    // Ant√©c√©dents familiaux
    if (scenario.antecedentsFamiliaux) {
        html += generateSectionObjetV3(scenario.antecedentsFamiliaux, 'antecedentsFamiliaux');
    }
    
    // Habitudes de vie
    if (scenario.habitudesVie) {
        html += generateHabitudesVieV3(scenario.habitudesVie);
    }
    
    // Contexte psychosocial
    if (scenario.contextePsychoSocial) {
        html += generateContextePsychoSocialV3(scenario.contextePsychoSocial);
    }
    
    // Simulation et jeu de r√¥le
    if (scenario.simulationJeuRole) {
        html += generateSimulationJeuRoleV3(scenario.simulationJeuRole);
    }
    
    // Signes d'alarme
    if (scenario.signesAlarme) {
        html += generateSectionObjetV3(scenario.signesAlarme, 'signesAlarme');
    }
    
    // Informations compl√©mentaires
    if (scenario.informationsComplementaires) {
        html += generateSectionObjetV3(scenario.informationsComplementaires, 'informationsComplementaires');
    }
    
    html += '    </div>\n';
    html += '</div>\n';
    return html;
}

// Fonction pour g√©n√©rer theoriePratique
function generateTheoriePratiqueV3(theorie) {
    let html = '<div class="annexe-item annexe-theorie">\n';
    html += '    <div class="annexe-title">' + getLabelV6('theoriePratique') + '</div>\n';
    html += '    <div class="annexe-content">\n';
    
    if (theorie.titre) {
        html += '        <h4>' + theorie.titre + '</h4>\n';
    }
    
    // Sections th√©oriques
    if (theorie.sections && theorie.sections.length > 0) {
        theorie.sections.forEach(section => {
            html += '        <div class="theory-section">\n';
            html += '            <h5>' + section.titre + '</h5>\n';
            if (section.contenu) {
                html += '            <p>' + colorizePatientResponses(section.contenu) + '</p>\n';
            }
            if (section.points && section.points.length > 0) {
                html += '            <ul>\n';
                section.points.forEach(point => {
                    html += '                <li>' + colorizePatientResponses(point) + '</li>\n';
                });
                html += '            </ul>\n';
            }
            html += '        </div>\n';
        });
    }
    
    // Rappels th√©rapeutiques
    if (theorie.rappelsTherapeutiques && theorie.rappelsTherapeutiques.length > 0) {
        html += '        <div class="theory-section">\n';
        html += '            <h5>' + getLabelV6('rappelsTherapeutiques') + '</h5>\n';
        html += '            <ul>\n';
        theorie.rappelsTherapeutiques.forEach(item => {
            html += '                <li>' + colorizePatientResponses(item) + '</li>\n';
        });
        html += '            </ul>\n';
        html += '        </div>\n';
    }
    
    // Examens compl√©mentaires
    if (theorie.examensComplementaires && theorie.examensComplementaires.length > 0) {
        html += '        <div class="theory-section">\n';
        html += '            <h5>' + getLabelV6('examensComplementaires') + '</h5>\n';
        html += '            <ul>\n';
        theorie.examensComplementaires.forEach(item => {
            html += '                <li>' + colorizePatientResponses(item) + '</li>\n';
        });
        html += '            </ul>\n';
        html += '        </div>\n';
    }
    
    // Diagnostic diff√©rentiel
    if (theorie.diagnosticDifferentiel && theorie.diagnosticDifferentiel.categories) {
        html += generateDiagnosticDifferentielV3(theorie.diagnosticDifferentiel);
    }
    
    // Prise en charge
    if (theorie.priseEnCharge) {
        html += generatePriseEnChargeV3(theorie.priseEnCharge);
    }
    
    // Protocoles sp√©cifiques
    if (theorie.protocolesSpecifiques) {
        html += generateProtocolesSpecifiquesV3(theorie.protocolesSpecifiques);
    }
    
    // Guide pratique
    if (theorie.guidePratique) {
        html += generateGuidePratiqueV3(theorie.guidePratique);
    }
    
    // Ressources
    if (theorie.ressources) {
        html += generateRessourcesV3(theorie.ressources);
    }
    
    html += '    </div>\n';
    html += '</div>\n';
    return html;
}

// =================== FONCTIONS UTILITAIRES V3 ===================

function generateIdentitePatientV3(identite) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('identitePatient') + '</h4>\n';
    
    const fields = ['nom', 'age', 'sexe', 'origine', 'profession', 'etatCivil', 'enfants'];
    const parts = [];
    
    fields.forEach(field => {
        if (identite[field]) {
            parts.push('<strong>' + getLabelV6(field) + ' :</strong> ' + colorizePatientResponses(identite[field]));
        }
    });
    
    if (parts.length > 0) {
        html += '            <p>' + parts.join(' | ') + '</p>\n';
    }
    
    html += '        </div>\n';
    return html;
}

function generateMotifConsultationV3(motif) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('motifConsultation') + '</h4>\n';
    
    if (motif.plaintePrincipale) {
        html += '            <p><strong>' + getLabelV6('plaintePrincipale') + ' :</strong> ' + colorizePatientResponses(motif.plaintePrincipale) + '</p>\n';
    }
    if (motif.autreChose) {
        html += '            <p><strong>' + getLabelV6('autreChose') + ' :</strong> ' + colorizePatientResponses(motif.autreChose) + '</p>\n';
    }
    
    html += '        </div>\n';
    return html;
}

function generateAnamneseActuelleV3(anamnese) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('anamn√®seActuelle') + '</h4>\n';
    
    // Histoire de la maladie
    if (anamnese.histoireMaladie) {
        html += generateSectionObjetV3(anamnese.histoireMaladie, 'histoireMaladie', 'h5');
    }
    
    // Caract√©ristiques du sympt√¥me principal
    if (anamnese.caracteristiquesSymptomePrincipal) {
        html += generateSectionObjetV3(anamnese.caracteristiquesSymptomePrincipal, 'caracteristiquesSymptomePrincipal', 'h5');
    }
    
    // Facteurs modulateurs
    if (anamnese.facteursModulateurs) {
        html += generateSectionObjetV3(anamnese.facteursModulateurs, 'facteursModulateurs', 'h5');
    }
    
    // Traitements tent√©s
    if (anamnese.traitementsTentes) {
        html += generateSectionObjetV3(anamnese.traitementsTentes, 'traitementsTentes', 'h5');
    }
    
    html += '        </div>\n';
    return html;
}

function generateSymptomesAssociesV3(symptomes) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('symptomesAssocies') + '</h4>\n';
    
    const categories = [
        'generaux', 'neurologiques', 'cardiovasculaires', 'respiratoires',
        'digestifs', 'urinaires', 'gynecologiques', 'musculosquelettiques',
        'dermatologiques', 'psychiatriques', 'ORL'
    ];
    
    categories.forEach(cat => {
        if (symptomes[cat] && hasContent(symptomes[cat])) {
            html += '            <div class="symptome-category">\n';
            html += '                <h5>' + getLabelV6(cat) + '</h5>\n';
            html += generateContentFromObjectV3(symptomes[cat]);
            html += '            </div>\n';
        }
    });
    
    html += '        </div>\n';
    return html;
}

function generateAntecedentsMedicauxV3(antecedents) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('antecedentsMedicaux') + '</h4>\n';
    
    // Maladies chroniques
    if (antecedents.maladiesChroniques && hasContent(antecedents.maladiesChroniques)) {
        html += '            <div class="antecedent-category">\n';
        html += '                <h5>' + getLabelV6('maladiesChroniques') + '</h5>\n';
        html += generateContentFromObjectV3(antecedents.maladiesChroniques);
        html += '            </div>\n';
    }
    
    // Arrays simples
    const simpleArrays = ['hospitalisations', 'chirurgies', 'traumatismes'];
    simpleArrays.forEach(key => {
        if (antecedents[key] && antecedents[key].length > 0) {
            html += '            <div class="antecedent-category">\n';
            html += '                <h5>' + getLabelV6(key) + '</h5>\n';
            html += '                <ul>\n';
            antecedents[key].forEach(item => {
                html += '                    <li>' + colorizePatientResponses(item) + '</li>\n';
            });
            html += '                </ul>\n';
            html += '            </div>\n';
        }
    });
    
    // Allergies
    if (antecedents.allergies && hasContent(antecedents.allergies)) {
        html += '            <div class="antecedent-category">\n';
        html += '                <h5>' + getLabelV6('allergies') + '</h5>\n';
        html += generateContentFromObjectV3(antecedents.allergies);
        html += '            </div>\n';
    }
    
    // Vaccinations
    if (antecedents.vaccinations && hasContent(antecedents.vaccinations)) {
        html += '            <div class="antecedent-category">\n';
        html += '                <h5>' + getLabelV6('vaccinations') + '</h5>\n';
        html += generateContentFromObjectV3(antecedents.vaccinations);
        html += '            </div>\n';
    }
    
    html += '        </div>\n';
    return html;
}

function generateMedicamentsActuelsV3(medicaments) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('medicamentsActuels') + '</h4>\n';
    html += generateContentFromObjectV3(medicaments);
    html += '        </div>\n';
    return html;
}

function generateHabitudesVieV3(habitudes) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('habitudesVie') + '</h4>\n';
    
    const keys = ['tabac', 'alcool', 'stupefiants', 'activitePhysique', 'alimentation', 'sommeil', 'sexualite'];
    
    keys.forEach(key => {
        if (habitudes[key] && hasContent(habitudes[key])) {
            html += '            <div class="habitude-category">\n';
            html += '                <h5>' + getLabelV6(key) + '</h5>\n';
            html += generateContentFromObjectV3(habitudes[key]);
            html += '            </div>\n';
        }
    });
    
    html += '        </div>\n';
    return html;
}

function generateContextePsychoSocialV3(contexte) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('contextePsychoSocial') + '</h4>\n';
    html += generateContentFromObjectV3(contexte);
    html += '        </div>\n';
    return html;
}

function generateSimulationJeuRoleV3(simulation) {
    let html = '        <div class="scenario-section">\n';
    html += '            <h4>' + getLabelV6('simulationJeuRole') + '</h4>\n';
    
    // Comportement patient
    if (simulation.comportementPatient) {
        html += '            <div class="simulation-category">\n';
        html += '                <h5>' + getLabelV6('comportementPatient') + '</h5>\n';
        html += generateContentFromObjectV3(simulation.comportementPatient);
        html += '            </div>\n';
    }
    
    // R√©ponses pr√©vues
    if (simulation.reponsesPrevues) {
        html += '            <div class="simulation-category">\n';
        html += '                <h5>' + getLabelV6('reponsesPrevues') + '</h5>\n';
        html += generateContentFromObjectV3(simulation.reponsesPrevues);
        html += '            </div>\n';
    }
    
    // D√©fis
    if (simulation.defis) {
        html += '            <div class="simulation-category">\n';
        html += '                <h5>' + getLabelV6('defis') + '</h5>\n';
        html += generateContentFromObjectV3(simulation.defis);
        html += '            </div>\n';
    }
    
    // √âl√©ments non verbaux
    if (simulation.elementsNonVerbaux) {
        html += '            <div class="simulation-category">\n';
        html += '                <h5>' + getLabelV6('elementsNonVerbaux') + '</h5>\n';
        html += generateContentFromObjectV3(simulation.elementsNonVerbaux);
        html += '            </div>\n';
    }
    
    html += '        </div>\n';
    return html;
}

function generateResultatsLaboratoireV3(resultats) {
    let html = '        <div class="info-section">\n';
    html += '            <h4>' + getLabelV6('resultatsLaboratoire') + '</h4>\n';
    
    // FSC
    if (resultats.fsc && hasContent(resultats.fsc)) {
        html += '            <div class="lab-category">\n';
        html += '                <h5>' + getLabelV6('fsc') + '</h5>\n';
        html += '                <ul>\n';
        Object.entries(resultats.fsc).forEach(([key, value]) => {
            if (value) {
                html += '                    <li><strong>' + key + ' :</strong> ' + value + '</li>\n';
            }
        });
        html += '                </ul>\n';
        html += '            </div>\n';
    }
    
    // Chimie sanguine
    if (resultats.chimieSanguine && hasContent(resultats.chimieSanguine)) {
        html += '            <div class="lab-category">\n';
        html += '                <h5>' + getLabelV6('chimieSanguine') + '</h5>\n';
        html += '                <ul>\n';
        Object.entries(resultats.chimieSanguine).forEach(([key, value]) => {
            if (value) {
                html += '                    <li><strong>' + key + ' :</strong> ' + value + '</li>\n';
            }
        });
        html += '                </ul>\n';
        html += '            </div>\n';
    }
    
    // Analyse d'urines
    if (resultats.analyseUrines && hasContent(resultats.analyseUrines)) {
        html += '            <div class="lab-category">\n';
        html += '                <h5>' + getLabelV6('analyseUrines') + '</h5>\n';
        html += '                <ul>\n';
        Object.entries(resultats.analyseUrines).forEach(([key, value]) => {
            if (value) {
                html += '                    <li><strong>' + key + ' :</strong> ' + value + '</li>\n';
            }
        });
        html += '                </ul>\n';
        html += '            </div>\n';
    }
    
    // Test de grossesse
    if (resultats.testGrossesse) {
        html += '            <p><strong>' + getLabelV6('testGrossesse') + ' :</strong> ' + resultats.testGrossesse + '</p>\n';
    }
    
    html += '        </div>\n';
    return html;
}

// Fonctions pour theoriePratique
function generateDiagnosticDifferentielV3(dd) {
    let html = '        <div class="theory-section">\n';
    html += '            <h5>' + getLabelV6('diagnosticDifferentiel') + '</h5>\n';
    
    if (dd.categories && dd.categories.length > 0) {
        dd.categories.forEach(cat => {
            html += '            <div class="dd-category">\n';
            html += '                <h6>' + cat.name + '</h6>\n';
            if (cat.items && cat.items.length > 0) {
                html += '                <ul>\n';
                cat.items.forEach(item => {
                    html += '                    <li>\n';
                    html += '                        <strong>' + item.text + '</strong>\n';
                    if (item.cause) html += '<br>Cause : ' + item.cause;
                    if (item.test) html += '<br>Test : ' + item.test;
                    html += '                    </li>\n';
                });
                html += '                </ul>\n';
            }
            html += '            </div>\n';
        });
    }
    
    html += '        </div>\n';
    return html;
}

function generatePriseEnChargeV3(pec) {
    let html = '        <div class="theory-section">\n';
    html += '            <h5>' + getLabelV6('priseEnCharge') + '</h5>\n';
    
    const sections = ['immediate', 'investigations', 'traitement', 'surveillance'];
    
    sections.forEach(section => {
        if (pec[section] && pec[section].length > 0) {
            html += '            <div class="pec-category">\n';
            html += '                <h6>' + section.charAt(0).toUpperCase() + section.slice(1) + '</h6>\n';
            html += '                <ul>\n';
            pec[section].forEach(item => {
                html += '                    <li>' + colorizePatientResponses(item) + '</li>\n';
            });
            html += '                </ul>\n';
            html += '            </div>\n';
        }
    });
    
    html += '        </div>\n';
    return html;
}

function generateProtocolesSpecifiquesV3(protocoles) {
    let html = '        <div class="theory-section">\n';
    html += '            <h5>' + getLabelV6('protocolesSpecifiques') + '</h5>\n';
    html += generateContentFromObjectV3(protocoles);
    html += '        </div>\n';
    return html;
}

function generateGuidePratiqueV3(guide) {
    let html = '        <div class="theory-section">\n';
    html += '            <h5>' + getLabelV6('guidePratique') + '</h5>\n';
    html += generateContentFromObjectV3(guide);
    html += '        </div>\n';
    return html;
}

function generateRessourcesV3(ressources) {
    let html = '        <div class="theory-section">\n';
    html += '            <h5>' + getLabelV6('ressources') + '</h5>\n';
    html += generateContentFromObjectV3(ressources);
    html += '        </div>\n';
    return html;
}

// Fonction g√©n√©rique pour g√©n√©rer une section objet
function generateSectionObjetV3(obj, sectionKey, headerLevel = 'h4') {
    let html = '        <div class="scenario-section">\n';
    html += '            <' + headerLevel + '>' + getLabelV6(sectionKey) + '</' + headerLevel + '>\n';
    html += generateContentFromObjectV3(obj);
    html += '        </div>\n';
    return html;
}

// Fonction pour g√©n√©rer le contenu d'un objet de mani√®re dynamique
function generateContentFromObjectV3(obj) {
    let html = '';
    
    if (typeof obj === 'string') {
        html += '            <p>' + colorizePatientResponses(obj) + '</p>\n';
    } else if (Array.isArray(obj)) {
        if (obj.length > 0) {
            html += '            <ul>\n';
            obj.forEach(item => {
                html += '                <li>' + colorizePatientResponses(item) + '</li>\n';
            });
            html += '            </ul>\n';
        }
    } else if (typeof obj === 'object') {
        Object.entries(obj).forEach(([key, value]) => {
            if (value && hasContent(value)) {
                const label = getLabelV6(key) || formatKeyToLabel(key);
                
                if (typeof value === 'string') {
                    html += '            <p><strong>' + label + ' :</strong> ' + colorizePatientResponses(value) + '</p>\n';
                } else if (Array.isArray(value)) {
                    if (value.length > 0) {
                        html += '            <div class="subsection">\n';
                        html += '                <strong>' + label + ' :</strong>\n';
                        html += '                <ul>\n';
                        value.forEach(item => {
                            html += '                    <li>' + colorizePatientResponses(item) + '</li>\n';
                        });
                        html += '                </ul>\n';
                        html += '            </div>\n';
                    }
                } else if (typeof value === 'object') {
                    html += '            <div class="subsection">\n';
                    html += '                <strong>' + label + ' :</strong>\n';
                    html += generateContentFromObjectV3(value);
                    html += '            </div>\n';
                }
            }
        });
    }
    
    return html;
}

// Fonction utilitaire pour v√©rifier si un objet a du contenu
function hasContent(obj) {
    if (!obj) return false;
    if (typeof obj === 'string') return obj.trim().length > 0;
    if (Array.isArray(obj)) return obj.length > 0;
    if (typeof obj === 'object') {
        return Object.values(obj).some(value => hasContent(value));
    }
    return false;
}

// Fonction pour formater une cl√© en label
function formatKeyToLabel(key) {
    return key
        .replace(/([A-Z])/g, ' $1')
        .replace(/^./, str => str.toUpperCase())
        .trim();
}

// Fonction pour obtenir le label v6
function getLabelV6(key) {
    return LABELS_V6[key] || getLabelV5(key) || formatKeyToLabel(key);
}

// =================== FIN DES FONCTIONS V6 ===================

</script>
</body>
</html>